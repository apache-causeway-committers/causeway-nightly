<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SOAP Fake Endpoints :: Apache Isis</title>
    <link rel="canonical" href="https://isis.apache.org/testing/unit-test-support/unit-test-support/soap-fake-server-junit-rule.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://isis.apache.org">Apache Isis</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="testing" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../about.html">Testing</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../about.html">About</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../about.html">Unit Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../integ-test-support/about.html">Integ Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../ext-specsupport/about.html">BDD Spec Support (extension)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../ext-fixtures/about.html">Fixture Scripts (extension)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Testing</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Architecture & Design</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../archdesign/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">DataNucleus ObjectStore</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../odn/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Demo</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../demoapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Hello World</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../helloworld/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - SimpleApp</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../simpleapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions - SecMan</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ext-secman/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Fundamentals & Beyond</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ug/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Guides - Reference Guides</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../rg/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Maven Dependencies</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mavendeps/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Migration Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mignotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Release Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../relnotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../vro/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Runtime Services</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../runtime-services/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../security/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">SmokeTest App</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../smoketests/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Table of Contents</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../toc/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Testing</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../vw/about.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../toc/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../about.html">Testing</a></li>
    <li><a href="soap-fake-server-junit-rule.html">SOAP Fake Endpoints</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/hobrom/antora/isis/core/testsupport/unittestsupport/_adoc/modules/unit-test-support/pages/unit-test-support/soap-fake-server-junit-rule.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">SOAP Fake Endpoints</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>No man is an island, and neither are most applications.  Chances are that at some point you may need to integrate your Apache Isis application to other external systems, possibly using old-style SOAP web services.  The SOAP client in this case could be a domain service within your app, or it might be externalized, eg invoked through a scheduler or using <a href="http://camel.apache.org">Apache Camel</a>.</p>
</div>
<div class="paragraph">
<p>While you will want to (of course) perform manual system testing/UAT with a test instance of that external system, it&#8217;s also useful to be able to perform unit testing of your SOAP client component.</p>
</div>
<div class="paragraph">
<p>The <code>SoapEndpointPublishingRule</code> is a simple JUnit rule that allows you to run a fake SOAP endpoint within an unit test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The (non-ASF) <a href="https://platform.incode.org" target="_blank" rel="noopener">Incode Platform</a>'s publishmq module provides a full example of how to integrate and test an Apache Isis application with a (faked out) external system.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="soapendpointpublishingrule"><a class="anchor" href="#soapendpointpublishingrule"></a><code>SoapEndpointPublishingRule</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The idea behind this rule is that you write a fake server endpoint that implements the same WSDL contract as the "real" external system does, but which also exposes additional API to specify responses (or throw exceptions) from SOAP calls.  It also typically records the requests and allows these to be queried.</p>
</div>
<div class="paragraph">
<p>In its setup your unit test and gets the rule to instantiate and publish that fake server endpoint, and then obtains a reference to that server endpoint.  It also instantiates the SOAP client, pointing it at the address (that is, a URL) that the fake server endpoint is running on.  This way the unit test has control of both the SOAP client and server: the software under test and its collaborator.</p>
</div>
<div class="paragraph">
<p>In the test methods your unit test sets up expectations on your fake server, and then exercises the SOAP client.  The SOAP client calls the fake server, which then responds accordingly.  The test can then assert that all expected interactions have occurred.</p>
</div>
<div class="paragraph">
<p>So that tests don&#8217;t take too long to run, the rule puts the fake server endpoints onto a thread-local.  Therefore the unit tests should clear up any state on the fake server endpoints.</p>
</div>
<div class="paragraph">
<p>Your unit test uses the rule by specifying the endpoint class (must have a no-arg constructor):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FakeExternalSystemEndpointRuleTest {
    @Rule
    public SoapEndpointPublishingRule serverRule =
        new SoapEndpointPublishingRule(FakeExternalSystemEndpoint.class);         <i class="conum" data-value="1"></i><b>(1)</b>
    private FakeExternalSystemEndpoint fakeServerEndpoint;
    private DemoObject externalSystemContract;                                    <i class="conum" data-value="2"></i><b>(2)</b>
    @Before
    public void setUp() throws Exception {
        fakeServerEndpoint =
            serverRule.getEndpointImplementor(FakeExternalSystemEndpoint.class);  <i class="conum" data-value="3"></i><b>(3)</b>
        final String endpointAddress =
            serverRule.getEndpointAddress(FakeExternalSystemEndpoint.class);      <i class="conum" data-value="4"></i><b>(4)</b>
        final DemoObjectService externalSystemService =                           <i class="conum" data-value="5"></i><b>(5)</b>
                new DemoObjectService(ExternalSystemWsdl.getWsdl());              <i class="conum" data-value="6"></i><b>(6)</b>
        externalSystemContract = externalSystemService.getDemoObjectOverSOAP();
        BindingProvider provider = (BindingProvider) externalSystemContract;
        provider.getRequestContext().put(
                BindingProvider.ENDPOINT_ADDRESS_PROPERTY,
                endpointAddress)
        );
    }
    @Test
    public void happy_case() throws Exception {
        // given
        final Update update = new Update();                              <i class="conum" data-value="7"></i><b>(7)</b>
        ...
        // expect
        final UpdateResponse response = new UpdateResponse();            <i class="conum" data-value="8"></i><b>(8)</b>
        ...
        fakeServerEndpoint.control().setResponse(updateResponse);
        // when
        PostResponse response = externalSystemContract.post(update);     <i class="conum" data-value="9"></i><b>(9)</b>
        // then
        final List&lt;Update&gt; updates =                                     <i class="conum" data-value="10"></i><b>(10)</b>
            fakeServerEndpoint.control().getUpdates();
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>specify the class that implements the endpoint (must have a no-arg constructor)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the SOAP contract as defined in WSDL and generated by wsdl2java</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>get hold of the fake server-side endpoint from the rule&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>&#8230;&#8203; and its endpoint address</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>use factory (also generated by wsdl2java) to create client-side endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>getWsdl()</code> is a utility method to return a URL for the WSDL (eg from the classpath)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>create a request object in order to invoke the SOAP web service</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>instruct the fake server endpoint how to respond</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>invoke the web service</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>check the fake server endpoint was correctly invoked etc.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rule can also host multiple endpoints; just provide multiple classes in the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Rule
public SoapEndpointPublishingRule serverRule =
                new SoapEndpointPublishingRule(
                    FakeCustomersEndpoint.class,
                    FakeOrdersEndpoint.class,
                    FakeProductsEndpoint.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To lookup a particular endpoint, specify its type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FakeProductsEndpoint fakeProductsServerEndpoint =
            serverRule.getPublishedEndpoint(FakeProductsEndpoint.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint addresses that the server endpoints run on are determined automatically.  If you want more control, then you can call one of <code>SoapEndpointPublishingRule</code>'s overloaded constructors, passing in one or more <code>SoapEndpointSpec</code> instances.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xml-marshalling-support"><a class="anchor" href="#xml-marshalling-support"></a>XML Marshalling Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Isis' unit testing support also provides helper <code>JaxbUtil</code> and <code>JaxbMatchers</code> classes.  These are useful if you have exampler XML-serialized representations of the SOAP requests and response payloads and want to use these within your tests.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
