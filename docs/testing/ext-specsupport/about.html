<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BDD Spec Support :: Apache Isis</title>
    <link rel="canonical" href="https://isis.apache.org/testing/ext-specsupport/about.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://isis.apache.org">Apache Isis</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="testing" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../about.html">Testing</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../about.html">About</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../unit-test-support/about.html">Unit Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../integ-test-support/about.html">Integ Test Support</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="about.html">BDD Spec Support (extension)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ext-fixtures/about.html">Fixture Scripts (extension)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Testing</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Architecture & Design</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../archdesign/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">DataNucleus ObjectStore</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../odn/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Demo</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../demoapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Hello World</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../helloworld/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - SimpleApp</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../simpleapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions - SecMan</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ext-secman/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Fundamentals & Beyond</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ug/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Guides - Reference Guides</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../rg/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Maven Dependencies</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mavendeps/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Migration Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mignotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Release Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../relnotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vro/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Runtime Services</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../runtime-services/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../security/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">SmokeTest App</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../smoketests/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Table of Contents</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../toc/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Testing</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vw/about.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../toc/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../about.html">Testing</a></li>
    <li><a href="about.html">BDD Spec Support (extension)</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/hobrom/antora/isis/extensions/specsupport/_adoc/modules/ext-specsupport/pages/about.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">BDD Spec Support</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/Behavior-driven_development">Behaviour-driven design</a> (BDD) redefines testing not as an after-the-fact "let&#8217;s check the system works", but rather as a means to work with the domain expert to (a) specify the behaviour of the feature <em>before</em> starting implementation, and (b) provide a means that the domain expert can verify the feature after it has been implemented.</p>
</div>
<div class="paragraph">
<p>Since domain experts are usually non-technical (at least, they are unlikely to be able to read or want to learn how to read JUnit/Java code), then applying BDD typically requires writing specifications in using structured English text and (ASCII) tables.  The BDD tooling parses this text and uses it to actually interact with the system under test.  As a byproduct the BDD frameworks generate readable output of some form; this is often an annotated version of the original specification, marked up to indicate which specifications passed, which have failed.  This readable output is a form of "living documentation"; it captures the actual behaviour of the system, and so is guaranteed to be accurate.</p>
</div>
<div class="paragraph">
<p>There are many BDD tools out there; Apache Isis provides an integration with <a href="https://cucumber.io/docs/reference/jvm#java">Cucumber JVM</a> (see also the <a href="https://github.com/cucumber/cucumber-jvm">github site</a>):</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-it-works"><a class="anchor" href="#how-it-works"></a>How it works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At a high level, here&#8217;s how Cucumber works</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specifications are written in the <a href="https://github.com/cucumber/cucumber/wiki/Gherkin">Gherkin</a> DSL, following the <a href="https://github.com/cucumber/cucumber/wiki/Given-When-Then">"given/when/then"</a> format.</p>
</li>
<li>
<p>Cucumber-JVM itself is a JUnit runner, and searches for <a href="https://github.com/cucumber/cucumber/wiki/Feature-Introduction">feature files</a> on the classpath.</p>
</li>
<li>
<p>These in turn are matched to <a href="https://github.com/cucumber/cucumber/wiki/Step-Definitions">step definition</a>s through regular expressions.<br></p>
<div class="paragraph">
<p>It is the step definitions (the "glue") that exercise the system.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The code that goes in step definitions is broadly the same as the code that goes in an integration test method.  One benefit of using step definitions (rather than integration tests) is that the step definitions are reusable across scenarios, so there may be less code overall to maintain.  For example, if you have a step definition that maps to "given an uncompleted todo item", then this can be used for all the scenarios that start with that as their precondition.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-a-bdd-spec"><a class="anchor" href="#writing-a-bdd-spec"></a>Writing a BDD spec</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BDD specifications contain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>XxxSpec.feature</code> file, describing the feature and the scenarios (given/when/then)s that constitute its acceptance criteria</p>
</li>
<li>
<p>a <code>RunSpecs.java</code> class file to run the specification (all boilerplate).
This will run all <code>.feature</code> files in the same package or subpackages.</p>
</li>
<li>
<p>one or several <code>XxxGlue</code> constituting the step definitions to be matched against.<br></p>
<div class="paragraph">
<p>The "glue" (step definitions) are intended to be reused across features.
We therefore recommend that they reside in a separate package, and are organized by the entity type upon which they act.<br></p>
</div>
<div class="paragraph">
<p>For example, given a feature that involves <code>Customer</code> and <code>Order</code>, have the step definitions pertaining to <code>Customer</code> reside in <code>CustomerGlue</code>, and the step definitions pertaining to <code>Order</code> reside in <code>OrderGlue</code>.<br></p>
</div>
<div class="paragraph">
<p>The <code>glue</code> attribute of the Cucumber-JVM JUnit runner allows you to indicate which package(s) should be recursively searched to find any glue.</p>
</div>
<div class="paragraph">
<p>There also needs to be one glue class that is used to bootstrap the runtime.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a feature from the <a href="../../simpleapp/about.html" class="page">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@DomainAppDemo
Feature: List and Create New Simple Objects

  Scenario: Existing simple objects can be listed and new ones created
    Given there are initially 10 simple objects
    When  I create a new simple object
    Then  there are 11 simple objects</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "@DomainAppDemo" is a custom tag we&#8217;ve specified to indicate the prerequisite fixtures to be loaded; more on this in a moment.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>BDD specs are assumed to run only as integration tests.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>RunBddSpecs</code> class to run this feature (and any other features in this package or subpackages) is just boilerplate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RunWith(Cucumber.class)
@CucumberOptions(
        format = {
                "html:target/cucumber-html-report"
                ,"json:target/cucumber.json"
        },
        glue={
                "classpath:domainapp.application.bdd.specglue",
                "classpath:domainapp.modules.simple.specglue"
        },
        strict = true,
        tags = { "~@backlog", "~@ignore" }
)
public class RunBddSpecs {
    // intentionally empty
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON formatter allows integration with enhanced reports.
(Commented out) configuration for this is provided in the <a href="../../simpleapp/about.html" class="page">SimpleApp archetype</a>.</p>
</div>
<div class="paragraph">
<p>The bootstrapping of Apache Isis itself lives in a <code>BootstrappingGlue</code> step definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BootstrappingGlue
                extends HeadlessWithBootstrappingAbstract { <i class="conum" data-value="1"></i><b>(1)</b>

    public BootstrappingGlue() {
        super(new DomainAppApplicationModule());            <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Before(order=100)                                      <i class="conum" data-value="3"></i><b>(3)</b>
    public void beforeScenario() {
        super.bootstrapAndSetupIfRequired();
    }
    @After
    public void afterScenario(cucumber.api.Scenario sc) {
        super.tearDownAllModules();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>superclass contains much of the bootstrapping logic (and is also used by the integration testing framework)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>Module</code> to use to bootstrap the application in headless mode.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>remainder of the class is just boilerplate.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For BDD specs, the <code>CukeGlueBootstrappingAbstract</code> was previously provided (as a BDD counterpart to <code>IntegrationTestAbstract3</code>) to perform the relevant bootstrapping.
<em>However</em>, it turns out that Cucumber does not allow subclassing of BDD specs.
Therefore the bootstrapping boilerplate (that ideally would have been factored out into an abstract superclass) must be included within the BDD spec.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The fixture to run also lives in its own step definition, <code>CatalogOfFixturesGlue</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CatalogOfFixturesGlue extends CukeGlueAbstract2 {
    @Before(value={"@DomainAppDemo"}, order=20000)
    public void runDomainAppDemo() {
        fixtureScripts.runFixtureScript(new DomainAppDemo(), null); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>fixtureScripts</code> service is inherited from the superclass.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will only activate for feature files tagged with "@DomainAppDemo".</p>
</div>
<div class="paragraph">
<p>Finally, the step definitions pertaining to <code>SimpleObject</code> domain entity then reside in the <code>SimpleObjectGlue</code> class.
This is where the heavy lifting gets done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SimpleObjectMenuGlue extends CukeGlueAbstract2 {

    @Given("^there are.* (\\d+) simple objects$")                           <i class="conum" data-value="1"></i><b>(1)</b>
    public void there_are_N_simple_objects(int n) throws Throwable {
        final List&lt;SimpleObject&gt; list = wrap(simpleObjectMenu).listAll();   <i class="conum" data-value="2"></i><b>(2)</b>
        assertThat(list.size(), is(n));
    }

    @When("^.*create a .*simple object$")
    public void create_a_simple_object() throws Throwable {
        wrap(simpleObjectMenu).create(UUID.randomUUID().toString());
    }

    @Inject
    SimpleObjectMenu simpleObjectMenu;                                      <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>regex to match to feature file specification</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the inherited <code>wrap(&#8230;&#8203;)</code> method delegates to <code>WrapperFactory#wrap(&#8230;&#8203;)</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>injected in the usual way</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="../../rg/svc/core-domain-api/Scratchpad.html" class="page"><code>Scratchpad</code></a> domain service is one way in which glue classes can pass state between each other.
Or, for more type safety, you could develop your own custom domain services for each scenario, and inject these in as regular services.
See <a href="http://www.thinkcode.se/blog/2017/04/01/sharing-state-between-steps-in-cucumberjvm-using-picocontainer">this blog</a> post for more details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If using Java 8, note that Cucumber JVM supports a <a href="https://cucumber.io/docs/reference/jvm#java-8-lambdas">simplified syntax using lambdas</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven-configuration"><a class="anchor" href="#maven-configuration"></a>Maven Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Isis' BDD spec support is automatically configured if you use the <a href="../../simpleapp/about.html" class="page">SimpleApp archetype</a>.
To set it up manually, update the <code>pom.xml</code> of your domain object model module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.isis.core&lt;/groupId&gt;
    &lt;artifactId&gt;isis-core-specsupport&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Normally <code>test</code>; usual Maven scoping rules apply.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration is wrapped up as maven mixins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugins&gt;
    &lt;plugin&gt;
        &lt;groupId&gt;com.github.odavid.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;mixin-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;0.1-alpha-39&lt;/version&gt;
        &lt;extensions&gt;true&lt;/extensions&gt;
        &lt;configuration&gt;
            &lt;mixins&gt;
                ...
                &lt;mixin&gt;
                    &lt;groupId&gt;com.danhaywood.mavenmixin&lt;/groupId&gt;
                    &lt;artifactId&gt;surefire&lt;/artifactId&gt;
                &lt;/mixin&gt;
                &lt;mixin&gt;
                    &lt;groupId&gt;com.danhaywood.mavenmixin&lt;/groupId&gt;
                    &lt;artifactId&gt;cucumberreporting&lt;/artifactId&gt;
                &lt;/mixin&gt;
            &lt;/mixins&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;
&lt;/plugins&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also find it more convenient to place the <code>.feature</code> files in <code>src/test/java</code>, rather than <code>src/test/resources</code>.
If you wish to do this, then your integtest module&#8217;s <code>pom.xml</code> must contain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
    &lt;testResources&gt;
        &lt;testResource&gt;
            &lt;filtering&gt;false&lt;/filtering&gt;
            &lt;directory&gt;src/test/resources&lt;/directory&gt;
        &lt;/testResource&gt;
        &lt;testResource&gt;
            &lt;filtering&gt;false&lt;/filtering&gt;
            &lt;directory&gt;src/test/java&lt;/directory&gt;
            &lt;includes&gt;
                &lt;include&gt;**&lt;/include&gt;
            &lt;/includes&gt;
            &lt;excludes&gt;
                &lt;exclude&gt;**/*.java&lt;/exclude&gt;
            &lt;/excludes&gt;
        &lt;/testResource&gt;
    &lt;/testResources&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
