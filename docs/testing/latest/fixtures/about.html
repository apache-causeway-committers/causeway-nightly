<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fixture Scripts :: causeway</title>
    <link rel="canonical" href="https://apache-causeway-committers.github.io/causeway-nightly/testing/latest/fixtures/about.html">
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/site-custom.css">
<link rel="home" href="https://apache-causeway-committers.github.io/causeway-nightly" title="causeway">
  <link rel="next" href="../fakedata/about.html" title="Fakedata">
  <link rel="prev" href="../specsupport/about.html" title="BDD Spec Support">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://apache-causeway-committers.github.io/causeway-nightly">
          <span class="icon">
            <img src="../../../_/img/causeway-logo-no-words-65x48.png"></img>
          </span>
        <span class="navbar-title">causeway</span>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <a class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Quick Start</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Starter Apps</span>
            <a class="navbar-item" href="../../../docs/latest/starters/helloworld.html">Hello World</a>
            <a class="navbar-item" href="../../../docs/latest/starters/simpleapp.html">Simple App</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Learning &amp; Tutorials</span>
            <a class="navbar-item" href="../../../docs/latest/reference/about.html">Reference App</a>
            <a class="navbar-item" href="https://danhaywood.gitlab.io/isis-petclinic-tutorial-docs/petclinic/1.16.2/intro.html">Petclinic</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Resources</span>
            <a class="navbar-item" href="../../../docs/latest/resources/cheatsheet.html">Cheatsheet</a>
            <a class="navbar-item" href="../../../docs/latest/resources/icons.html">Icons</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Core</span>
            <a class="navbar-item" href="../../../userguide/latest/about.html">User Guide</a>
            <a class="navbar-item" href="../../../refguide/latest/about.html">Reference Guide</a>
            <a class="navbar-item" href="../../../testing/latest/about.html">Testing Guide</a>
            <a class="navbar-item" href="../../../security/latest/about.html">Security Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">For use in apps</span>
            <a class="navbar-item" href="../../../valuetypes/latest/about.html">Value Types</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Development</span>
            <a class="navbar-item" href="../../../setupguide/latest/about.html">Setup Guide</a>
            <a class="navbar-item" href="../../../conguide/latest/about.html">Contributors' Guide</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Security</span>
            <a class="navbar-item" href="../../../security/latest/bypass/about.html">Bypass</a>
            <a class="navbar-item" href="../../../security/latest/simple/about.html">Simple</a>
            <a class="navbar-item" href="../../../security/latest/spring/about.html">Spring</a>
            <a class="navbar-item" href="../../../security/latest/keycloak/about.html">Keycloak</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Viewers</span>
            <a class="navbar-item" href="../../../vw/latest/about.html">Web UI (Wicket)</a>
            <a class="navbar-item" href="../../../gqlv/latest/about.html">GraphQL API</a>
            <a class="navbar-item" href="../../../vro/latest/about.html">REST API (Restful Objects)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Persistence</span>
            <a class="navbar-item" href="../../../pjpa/latest/about.html">JPA (EclipseLink)</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Extensions</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Core</span>
            <a class="navbar-item" href="../../../userguide/latest/commandlog/about.html">Command Log</a>
            <a class="navbar-item" href="../../../userguide/latest/docgen/about.html">Doc Gen</a>
            <a class="navbar-item" href="../../../userguide/latest/executionlog/about.html">Execution Log</a>
            <a class="navbar-item" href="../../../userguide/latest/executionoutbox/about.html">Execution Outbox</a>
            <a class="navbar-item" href="../../../userguide/latest/executionrepublisher/about.html">Execution Republisher</a>
            <a class="navbar-item" href="../../../userguide/latest/excel/about.html">Excel</a>
            <a class="navbar-item" href="../../../userguide/latest/flyway/about.html">Flyway</a>
            <a class="navbar-item" href="../../../userguide/latest/layoutloaders/about.html">Layout Loaders</a>
            <a class="navbar-item" href="../../../userguide/latest/titlecache/about.html">Title Cache</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Security</span>
            <a class="navbar-item" href="../../../security/latest/secman/about.html">Secman</a>
            <a class="navbar-item" href="../../../security/latest/audittrail/about.html">Audit Trail</a>
            <a class="navbar-item" href="../../../security/latest/spring-oauth2/about.html">Spring OAuth2 Integration</a>
            <a class="navbar-item" href="../../../security/latest/sessionlog/about.html">Session Log</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Web UI (Wicket)</span>
            <a class="navbar-item" href="../../../vw/latest/fullcalendar/about.html">Full Calendar</a>
            <a class="navbar-item" href="../../../vw/latest/pdfjs/about.html">pdf.js</a>
            <a class="navbar-item" href="../../../vw/latest/sse/about.html">Server Side Events</a>
            <a class="navbar-item" href="../../../vw/latest/tabular/about.html">Tabular Download</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">REST API (Restful Objects)</span>
            <a class="navbar-item" href="../../../vro/latest/cors/about.html">CORS</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Persistence</span>
            <a class="navbar-item" href="../../../querydsl/latest/about.html">QueryDSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Support</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Contact</span>
            <a class="navbar-item" href="../../../docs/latest/support/slack-channel.html">Slack</a>
            <a class="navbar-item" href="../../../docs/latest/support/mailing-list.html">Mailing Lists</a>
            <a class="navbar-item" href="https://issues.apache.org/jira/browse/CAUSEWAY">JIRA</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/causeway">Stack Overflow</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Releases</span>
            <a class="navbar-item" href="../../../docs/latest/downloads/how-to.html">Downloads</a>
            <a class="navbar-item" href="../../../relnotes/latest/about.html">Release Notes</a>
            <hr class="navbar-divider"/>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Framework</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Process</span>
            <a class="navbar-item" href="../../../comguide/latest/about.html">Committers' Guide</a>
            <a class="navbar-item" href="../../../tooling/latest/about.html">Tooling</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Automated Analysis</span>
            <a class="navbar-item" href="https://sonarcloud.io/dashboard?id=apache_causeway">SonarCloud.io</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Interim Builds</span>
            <a class="navbar-item" href="../../../comguide/latest/nightly-builds.html">Nightly builds</a>
            <a class="navbar-item" href="../../../comguide/latest/weekly-builds.html">Weekly builds</a>
            <a class="navbar-item" href="https://apache-causeway-committers.github.io/causeway-nightly">Website Preview (not ASF hosted)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Development</span>
            <a class="navbar-item" href="../../../core/latest/about.html">Internal Design Docs</a>
            <a class="navbar-item" href="../../../regressiontests/latest/about.html">Regression Tests</a>
            <a class="navbar-item" href="../../../incubator/latest/about.html">Incubator</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Thanks</span>
            <a class="navbar-item" href="../../../more-thanks/latest/more-thanks.html">Acknowledgements</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">ASF</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="http://www.apache.org/">Apache Homepage</a>
            <a class="navbar-item" href="https://www.apache.org/events/current-event">Events</a>
            <a class="navbar-item" href="https://www.apache.org/licenses/">License</a>
            <a class="navbar-item" href="https://www.apache.org/security/">Security</a>
            <a class="navbar-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <hr class="navbar-divider"/>
            <a class="navbar-item" href="https://whimsy.apache.org/board/minutes/Causeway.html">PMC board minutes</a>
          </div>
        </div>
        <a class="navbar-item" href="../../../docs/latest/about.html">
          <span class="icon">
            <img src="../../../_/img/home.png"></img>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body ">
<div class="nav-container" data-component="testing" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-search hide-for-print">
  <input id="algolia-search-input" placeholder="Search"></span>
</div>
<div class="nav-panel-pagination">
  <a class="page-previous" rel="prev" href="../specsupport/about.html" title="BDD Spec Support"><span></span></a>
  <a class="page-next" rel="next"
     href="../fakedata/about.html" title="Fakedata"><span></span></a>
<!--
page.parent doesn't seem to be set...
  <a class="page-parent disabled" rel="prev" href="" title="BDD Spec Support"><span></span></a>
-->
</div>
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../about.html">Testing Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../unittestsupport/about.html">Unit Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../integtestsupport/about.html">Integ Test Support</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integtestsupport/influencing-the-interaction.html">Influencing the Interaction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integtestsupport/domain-model-validator.html">Domain Model Validator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integtestsupport/swagger-exporter.html">Swagger Exporter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integtestsupport/hints-and-tips.html">Hints and Tips</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../specsupport/about.html">BDD Spec Support</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="about.html">Fixture Scripts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fakedata/about.html">Fakedata</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../archtestsupport/about.html">Architecture Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../h2console/about.html">H2 Console</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../hsqldbmgr/about.html">HSQLDB Manager</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Testing Guide</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title"> </span>
      <ul class="versions">
        <li class="version">
          <a href="../../../docs/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Committers' Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../comguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Contributors' Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../conguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Design Docs</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../core/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../extensions/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">GraphQL Viewer</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../gqlv/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Incubator Catalog</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../incubator/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">JPA</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../pjpa/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">QueryDSL</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../querydsl/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Reference Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../refguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">regressiontests</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../regressiontests/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Release Notes</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../relnotes/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">REST API (Restful Objects Viewer)</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../vro/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../security/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Setup Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../setupguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Testing Guide</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Tutorials</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../tutorials/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">User Guide</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../userguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Value Types Catalog</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../valuetypes/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Web UI (Wicket Viewer)</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../vw/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../docs/latest/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../about.html">Testing Guide</a></li>
    <li><a href="about.html">Fixture Scripts</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/apache/causeway/edit/main/testing/fixtures/adoc/modules/fixtures/pages/about.adoc">Edit</a></div>
</div>
<article class="doc">
    <a name="section-top"></a>
<h1 class="page">Fixture Scripts</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When writing integration tests (and implementing the glue for BDD specs) it can be difficult to keep the "given" short; there could be a lot of prerequisite data that needs to exist before you can actually exercise your system.
Moreover, however we do set up that data, but we also want to do so in a way that is resilient to the system changing over time.</p>
</div>
<div class="paragraph">
<p>On a very simple system you could probably get away with using SQL to insert directly into the database, or you could use a toolkit such as <a href="http://dbunit.sourceforge.net/howto.html">dbunit</a> to upload data from flat files.
Such approaches aren&#8217;t particularly maintainable though.
If in the future the domain entities (and therefore corresponding database tables) change their structure, then all of those data sets will need updating.</p>
</div>
<div class="paragraph">
<p>Even more significantly, there&#8217;s no way to guarantee that the data that&#8217;s being loaded is logically consistent with the business behaviour of the domain objects themselves.
That is, there&#8217;s nothing to stop your test from putting data into the database that would be invalid if one attempted to add it through the app.</p>
</div>
<div class="paragraph">
<p>The solution that Apache Causeway provides is a small library called <strong><em>fixture scripts</em></strong>.
A fixture script is basically a command object for executing arbitrary work, where the work in question is almost always invoking one or more business actions.
In other words, the database is populating through the functionality of the domain object model itself.</p>
</div>
<div class="paragraph">
<p>There is another benefit to Apache Causeway' fixture script approach; the fixtures can be (in prototyping mode) run from your application.
This means that fixture scripts can actually help all the way through the development lifecycle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when specifying a new feature, you can write a fixture script to get the system into the "given" state, and then start exploring the required functionality with the domain expert actually <em>within</em> the application<br></p>
<div class="paragraph">
<p>And if you can&#8217;t write a fixture script for the story, it probably means that there&#8217;s some prerequisite feature that needs implementing that you hadn&#8217;t previously recognized</p>
</div>
</li>
<li>
<p>when the developer implements the story, s/he has a precanned script to run when they manually verify the functionality works</p>
</li>
<li>
<p>when the developer automates the story&#8217;s acceptance test as an integration test, they already have the "given" part of the test implemented</p>
</li>
<li>
<p>when you want to pass the feature over to the QA/tester for additional manual exploratory testing, they have a fixture script to get them to a jumping off point for their explorations</p>
</li>
<li>
<p>when you want to demonstrate the implemented feature to your domain expert, your demo can use the fixture script so you don&#8217;t bore your audience in performing lots of boring setup before getting to the actual feature</p>
</li>
<li>
<p>when you want to roll out training to your users, you can write fixture scripts as part of their training exercises</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections explain how to setup Maven, describe the API and discuss how to mock the clock or the current user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven-configuration"><a class="anchor" href="#maven-configuration"></a>Maven Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="dependency-management"><a class="anchor" href="#dependency-management"></a>Dependency Management</h3>
<div class="paragraph">
<p>If your application inherits from the Apache Causeway starter app (<code>org.apache.causeway.app:causeway-app-starter-parent</code>) then that will define the version automatically:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;parent&gt;
    &lt;groupId&gt;org.apache.causeway.app&lt;/groupId&gt;
    &lt;artifactId&gt;causeway-app-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;3.4.0&lt;/version&gt;
    &lt;relativePath/&gt;
&lt;/parent&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, import the core BOM.
This is usually done in the top-level parent pom of your application:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.causeway.core&lt;/groupId&gt;
            &lt;artifactId&gt;causeway-core&lt;/artifactId&gt;
            &lt;version&gt;3.4.0&lt;/version&gt;
            &lt;scope&gt;import&lt;/scope&gt;
            &lt;type&gt;pom&lt;/type&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, add an entry for the BOM of all the testing support libraries:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
        	&lt;groupId&gt;org.apache.causeway.testing&lt;/groupId&gt;
	        &lt;artifactId&gt;causeway-testing&lt;/artifactId&gt;
            &lt;scope&gt;import&lt;/scope&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;version&gt;3.4.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h3>
<div class="paragraph">
<p>In the domain module(s) of your application, add the following dependency:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.causeway.testing&lt;/groupId&gt;
        &lt;artifactId&gt;causeway-testing-fixtures-applib&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update-appmanifest"><a class="anchor" href="#update-appmanifest"></a>Update AppManifest</h3>
<div class="paragraph">
<p>In your application&#8217;s <code>AppManifest</code> (top-level Spring <code>@Configuration</code> used to bootstrap the app), import the <code>CausewayModuleTestingFixturesApplib</code> module:</p>
</div>
<div class="listingblock">
<div class="title">AppManifest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@Import({
        ...
        CausewayModuleTestingFixturesApplib.class,
        ...
})
public class AppManifest {
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-and-usage"><a class="anchor" href="#api-and-usage"></a>API and Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fixture scripts are used to set up the system into a known state, which almost always means to populate the database.
The most common use case is for integration testing, but they are also useful while prototyping/demo&#8217;ing.
In both cases the system is almost always running against an in-memory database, meaning that the entire state of the system needs to be setup.
As it wouldn&#8217;t be scalable to have one huge fixture script for this purpose, fixture scripts are usually organised hierarchically, with higher-level fixture scripts calling child fixture scripts that set up the
individual parts the system (eg rows into a specific entity).</p>
</div>
<div class="paragraph">
<p>Fixture scripts are usually implemented by calling the business logic of the domain application.
This is preferable to, for example, <code>INSERT</code>ing rows directly into database tables, because they are robust to implementation changes over time.</p>
</div>
<div class="paragraph">
<p>Fixture scripts are implemented by subclassing from the <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript.html" class="xref page">FixtureScript</a> abstract class.
In most cases you&#8217;ll want to use one of the variants provided by the framework; these are described in more detail <a href="#fixturescript">below</a>.</p>
</div>
<div class="paragraph">
<p>Fixture scripts are executed using the  <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html" class="xref page">FixtureScripts</a> domain service class.
This provides menu actions in the UI of your application (when running in prototype mode).
Typically it will only make sense for a small subset of the available fixture scripts to be exposed through the UI, for example those representing scenarios to be explored/demo&#8217;ed.
The behaviour of the <code>FixtureScripts</code> domain service and the discovery of scenario fixture scripts is managed by configuration properties.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at <code>FixtureScripts</code> domain service in more detail <a href="#fixturescripts">first</a>, <a href="#fixturescript">then</a> move onto exploring <code>FixtureScript</code>.</p>
</div>
<div class="sect2">
<h3 id="fixturescripts"><a class="anchor" href="#fixturescripts"></a><code>FixtureScripts</code></h3>
<div class="paragraph">
<p>The <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html" class="xref page">FixtureScripts</a> domain service.
This is annotated to be part of on the secondary "Prototyping" menu.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how the domain service looks like in the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prototyping-menu.png" alt="prototyping menu" width="700px">
</div>
</div>
<div class="paragraph">
<p>and here&#8217;s what the <code>runFixtureScript</code> action prompt looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prompt.png" alt="prompt" width="700px">
</div>
</div>
<div class="paragraph">
<p>when this is executed, the resultant objects (actually, instances of FixtureResult`) are shown in the UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/result-list.png" alt="result list" width="700px">
</div>
</div>
<div class="paragraph">
<p>The <code>FixtureScripts</code> domain service also provides the <code>recreateObjectsAndReturnFirst</code> action.
This is a convenience, saving a few clicks: it will run a nominated fixture script and return the first object created by that fixture script.</p>
</div>
<div class="sect3">
<h4 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a>Configuration Properties</h4>
<div class="paragraph">
<p>The behaviour of this domain menu service can be configured using the <code>causeway.testing.fixtures.fixture-script-specification</code> configuration properties.
For example, here&#8217;s the configuration used by the <a href="../../../docs/latest/starters/simpleapp.html" class="xref page">SimpleApp</a> starter apps:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">causeway:
  testing:
    fixtures:
      fixture-scripts-specification:
        context-class: domainapp.webapp.application.fixture.scenarios.DomainAppDemo <i class="conum" data-value="1"></i><b>(1)</b>
        multiple-execution-strategy: execute <i class="conum" data-value="2"></i><b>(2)</b>
        run-script-default: domainapp.webapp.application.fixture.scenarios.DomainAppDemo <i class="conum" data-value="3"></i><b>(3)</b>
        recreate: domainapp.webapp.application.fixture.scenarios.DomainAppDemo <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>search for all fixture scripts under the package containing this class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>if the same fixture script (class) is encountered more than once, then run anyway.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>specify the fixture script class to provide as the default for the service&#8217;s "run fixture script" action</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>if present, enables a "recreate objects and return first" action to be displayed in the UI</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more details, see <a href="../../../refguide/latest/config/sections/causeway.testing.html#causeway.testing.fixtures.fixture-scripts-specification.context-class" class="xref page">causeway.testing.fixtures.fixture-scripts-specification</a> config properties in the configuration guide.</p>
</div>
</div>
<div class="sect3">
<h4 id="menubars"><a class="anchor" href="#menubars"></a>Menubars</h4>
<div class="paragraph">
<p>The actions of <code>FixtureScripts</code> domain service are automatically placed on the "Prototyping" menu.
This can be fine-tuned using <code>menubars.layout.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">menubars.layout.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;mb:section&gt;
    &lt;mb:named&gt;Fixtures&lt;/mb:named&gt;
    &lt;mb:serviceAction
        objectType="causeway.testing.fixtures.FixtureScripts"
        id="runFixtureScript"/&gt;
    &lt;mb:serviceAction
        objectType="causeway.testing.fixtures.FixtureScripts"
        id="recreateObjectsAndReturnFirst"/&gt;
&lt;/mb:section&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now look at the <code>FixtureScript</code> class, where there&#8217;s a bit more to discuss.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fixturescript"><a class="anchor" href="#fixturescript"></a><code>FixtureScript</code></h3>
<div class="paragraph">
<p>A <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript.html" class="xref page">FixtureScript</a> is responsible for setting up the system (or more likely, one small part of the overall system) into a known state, either for prototyping or for integration testing.</p>
</div>
<div class="paragraph">
<p>The normal idiom is for the fixture script to invoke actions on business objects, in essence to replay what a real-life user would have done.
That way, the fixture script will remain valid even if the underlying implementation of the system changes in the future.</p>
</div>
<div class="paragraph">
<p>For example, here&#8217;s a fixture script called <code>RecreateSimpleObjects</code>.
(This used to be part of the <a href="../../../docs/latest/starters/simpleapp.html" class="xref page">SimpleApp</a> starter app, though it now has a more sophisticated design, discussed below):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import lombok.Accessors;
import lombok.Getter;
import lombok.Setter;

@Accessors(chain = true)
public class RecreateSimpleObjects extends FixtureScript {       <i class="conum" data-value="1"></i><b>(1)</b>

    public final List&lt;String&gt; NAMES =
        Collections.unmodifiableList(Arrays.asList(
            "Foo", "Bar", "Baz", "Frodo", "Froyo",
            "Fizz", "Bip", "Bop", "Bang", "Boo"));               <i class="conum" data-value="2"></i><b>(2)</b>
    public RecreateSimpleObjects() {
        withDiscoverability(Discoverability.DISCOVERABLE);       <i class="conum" data-value="3"></i><b>(3)</b>
    }

    @Getter @Setter
    private Integer number;                                      <i class="conum" data-value="4"></i><b>(4)</b>

    @Getter
    private final List&lt;SimpleObject&gt; simpleObjects =
                                        Lists.newArrayList();    <i class="conum" data-value="5"></i><b>(5)</b>

    @Override
    protected void execute(final ExecutionContext ec) {          <i class="conum" data-value="6"></i><b>(6)</b>

        // defaults
        final int number = defaultParam("number", ec, 3);        <i class="conum" data-value="7"></i><b>(7)</b>

        // validate
        if(number &lt; 0 || number &gt; NAMES.size()) {
            throw new IllegalArgumentException(
                String.format("number must be in range [0,%d)", NAMES.size()));
        }

        // execute
        ec.executeChild(this, new SimpleObjectsTearDown());      <i class="conum" data-value="8"></i><b>(8)</b>
        for (int i = 0; i &lt; number; i++) {
            final SimpleObjectCreate fs =
                new SimpleObjectCreate().setName(NAMES.get(i));
            ec.executeChild(this, fs.getName(), fs);             <i class="conum" data-value="9"></i><b>(9)</b>
            simpleObjects.add(fs.getSimpleObject());             <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inherit from <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript.html" class="xref page">FixtureScript</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a hard-coded list of values for the names.
Note that the <a href="../fakedata/about.html" class="xref page">Fakedata</a> testing module could also have been used</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>whether the script is "discoverable"; in other words whether it should be rendered in the drop-down by the <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html" class="xref page">FixtureScripts</a> domain service</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>input property: the number of objects to create, up to 10; for the calling test to specify, but note this is optional and has a default (see below).
It&#8217;s important that a wrapper class is used (ie <code>java.lang.Integer</code>, not <code>int</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>output property: the generated list of objects, for the calling test to grab</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>the mandatory <code>execute(&#8230;&#8203;)</code> API.
The <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript_ExecutionContext.html" class="xref page">ExecutionContext</a> parameter is discussed in more detail in the <a href="#executioncontext">next section</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>the <code>defaultParam(&#8230;&#8203;)</code> (inherited from <code>FixtureScript</code>) will default the <code>number</code> property (using Java&#8217;s Reflection API) if none was specified</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>call another fixture script (<code>SimpleObjectsTearDown</code>) using the provided <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript_ExecutionContext.html" class="xref page">ExecutionContext</a>.
There&#8217;s no need to instantiate using the <a href="../../../refguide/latest/applib/index/services/factory/FactoryService.html" class="xref page">FactoryService</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>calling another fixture script (<code>SimpleObjectCreate</code>) using the provided <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript_ExecutionContext.html" class="xref page">ExecutionContext</a></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>adding the created object to the list, for the calling object to use.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Because this script has exposed a "number" property, it&#8217;s possible to set this from within the UI.
For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prompt-specifying-number.png" alt="prompt specifying number" width="700px">
</div>
</div>
<div class="paragraph">
<p>When this is executed, the framework will parse the text and attempt to reflectively set the corresponding properties on the fixture result.
So, in this case, when the fixture script is executed we actually get 6 objects created.</p>
</div>
</div>
<div class="sect2">
<h3 id="executioncontext"><a class="anchor" href="#executioncontext"></a>ExecutionContext</h3>
<div class="paragraph">
<p>The <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript_ExecutionContext.html" class="xref page">ExecutionContext</a> is passed to each <code>FixtureScript</code> as it is executed.
It supports two main use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to allow child fixture scripts to be executed, using <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScript_ExecutionContext.html#executeChildT_FixtureScript_T" class="xref page">executeChild(&#8230;&#8203;)</a> and its brethren.</p>
<div class="paragraph">
<p>This was demonstrated in the <a href="#fixturescript">previous section</a></p>
</div>
</li>
<li>
<p>to read parameters obtained when the fixture script was first executed by the <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html" class="xref page">FixtureScripts</a> domain service, discussed <a href="#fixturescripts">above</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The latter use case is much less frequently used, but can be helpful for example in demos, where the number of objects can be specified in the <code>parameters</code> parameter of the <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html#runFixtureScript_String_String" class="xref page">run fixture script</a> action.</p>
</div>
</div>
<div class="sect2">
<h3 id="personas-and-builders"><a class="anchor" href="#personas-and-builders"></a>Personas and Builders</h3>
<div class="paragraph">
<p>Good integration tests are probably the best way to understand the behaviour of the domain model: better, even, than reading the code itself.
This requires though that the tests are as minimal as possible so that the developer reading the test knows that everything mentioned in the test is essential to the functionality under test.</p>
</div>
<div class="paragraph">
<p>At the same time, "Persona" instances of entity classes help the developer become familiar with the data being set up.
For example, "Steve Single" the Customer might be 21, single and no kids, whereas vs "Meghan Married-Mum" the Customer might be married 35 with 2 kids.
Using "Steve" vs "Meghan" immediately informs the developer about the particular scenario being explored.</p>
</div>
<div class="paragraph">
<p>The <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/Persona.html" class="xref page">Persona</a> interfaces is intended to be implemented typically by "persona" enums, where each enum instance captures the essential data of some persona.
<a href="../../../refguide/latest/testing/index/fixtures/applib/personas/Persona.html" class="xref page">Persona</a> in turn unifies two lower-level interfaces, <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/PersonaWithBuilderScript.html" class="xref page">PersonaWithBuilderScript</a> and
<a href="../../../refguide/latest/testing/index/fixtures/applib/personas/PersonaWithFinder.html" class="xref page">PersonaWithFinder</a>.</p>
</div>
<div class="paragraph">
<p>So, going back to the previous example, we might have:</p>
</div>
<div class="listingblock">
<div class="title">Customer_persona.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">@Getter
@RequiredArgsConstructor
public enum Customer_persona
        implements Persona&lt;Customer, CustomerBuilderScript&gt; {

    SteveSingle(1, "Steve", "Single", 21),
    MeghanMarriedMum(2, "Meghan", "Married-Mum", 35);

    private final int id;
    private final String firstName;
    private final String lastName;
    private final int age;

    @Override
    public CustomerBuilderScript builder() {                            <i class="conum" data-value="1"></i><b>(1)</b>
        return new CustomerBuilderScript(this);                         <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Override
    public Customer findUsing(ServiceRegistry serviceRegistry) {        <i class="conum" data-value="3"></i><b>(3)</b>
        return serviceRegistry.lookupServiceElseFail(CustomerRepository.class).findById(id).orElseThrow();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>from <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/PersonaWithBuilderScript.html" class="xref page">PersonaWithBuilderScript</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>it&#8217;s idiomatic to just pass self to the build script.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>from <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/PersonaWithFinder.html" class="xref page">PersonaWithFinder</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here the <code>CustomerBuilderScript</code> is a subclass of <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/BuilderScriptAbstract.html" class="xref page">BuilderScriptAbstract</a>,  a specialized fixture script that acts as a factory of the domain object (<code>Customer</code>, in this case), usig the data taken out of the enum instance.
In many cases a builder script will create a single top-level object, so the related <a href="../../../refguide/latest/testing/index/fixtures/applib/personas/BuilderScriptWithResult.html" class="xref page">BuilderScriptWithResult</a> removes some boilerplate:</p>
</div>
<div class="listingblock">
<div class="title">CustomerBuilderScript.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RequiredArgsConstructor
public class CustomerBuilderScript extends BuilderScriptWithResult&lt;Customer&gt; {

    private final Customer_persona persona;

    @Override
    protected Customer buildResult(ExecutionContext ec) {
        return customerRepository.create(persona.getFirstName(), persona.getLastName(), persona.getAge());
    }

    @Inject CustomerRepository customerRepository;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Put together, the persona enums provide the "what" - hard-coded values for certain key data that the developer becomes very familiar with - while the builder provides the "how-to".</p>
</div>
<div class="sect3">
<h4 id="using-within-a-scenario-fixture-script"><a class="anchor" href="#using-within-a-scenario-fixture-script"></a>Using within a Scenario Fixture Script</h4>
<div class="paragraph">
<p>With these definitions in place, the payback is that within the context of a parent fixture script, a new domain object can be easily built and retrieved later:</p>
</div>
<div class="listingblock">
<div class="title">ScenarioFixtureScript.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ScenarioFixtureScript extends FixtureScript {

    @Override
    protected void execute(ExecutionContext executionContext) {

        // build it ..
        Customer steve = Customer_persona.SteveSingle.build(this, executionContext);

        // ... look it up
        Customer steve2 = Customer_persona.SteveSingle.findUsing(serviceRegistry);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to use personas (or indeed any fixture scripts) from integration tests.
This is discussed in the next section.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-within-tests"><a class="anchor" href="#using-within-tests"></a>Using within Tests</h4>
<div class="paragraph">
<p>Fixture scripts can be called from integration tests just the same way that fixture scripts can call one another.</p>
</div>
<div class="paragraph">
<p>Using the example persona from the previous section, we can use the <a href="../../../refguide/latest/testing/index/fixtures/applib/fixturescripts/FixtureScripts.html" class="xref page">FixtureScripts</a> domain service to build the fixture.</p>
</div>
<div class="listingblock">
<div class="title">Customer_IntegTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Customer_IntegTest {

    @Inject FixtureScripts fixtureScripts;
    @Inject ServiceRegistry serviceRegistry;

    @BeforeEach
    public void setup() {

        // build ...
        Customer steve = fixtureScripts.runPersona(Customer_persona.SteveSingle);       <i class="conum" data-value="1"></i><b>(1)</b>

    }

    @Test
    public void update_customer() {

        // ... look it up
        Customer steve = Customer_persona.SteveSingle.findUsing(serviceRegistry);   <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>runs a persona fixture script</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>looks up the domain object.
An alternative design would be to simply store the domain object as a field.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="more-sophisticated-use-cases"><a class="anchor" href="#more-sophisticated-use-cases"></a>More sophisticated use cases</h4>
<div class="paragraph">
<p>Although its idiomatic for builder scripts (<a href="../../../refguide/latest/testing/index/fixtures/applib/personas/BuilderScriptAbstract.html" class="xref page">BuilderScriptAbstract</a> implementations) and persona enums to come in pairs, there&#8217;s no requirement to do so; builder scripts  can be used independently of the enum personas.
And for more complex entity -where there might be many potential values that need to be provided
- the builder script can automatically default some or even all of these values.</p>
</div>
<div class="paragraph">
<p>For example, for a customer&#8217;s date of birth, the builder could default to a date making the customer an adult, aged between 18 and 65, say.
For an email address or postal address, or an image, or some "lorem ipsum" text, the <a href="../fakedata/about.html" class="xref page">Fakedata</a> testing module could provide randomised values.</p>
</div>
<div class="paragraph">
<p>The benefit of an intelligent builder is that it further simplifies the test.
The developer reading the test then knows that everything that has been specified exactly is of significance.
Because non-specified values are randomised and change on each run, it also decreases the chance that the test passes "by accident" (based on some lucky hard-coded input value).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mocking-the-clock-or-user"><a class="anchor" href="#mocking-the-clock-or-user"></a>Mocking the Clock or User</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html" class="xref page">SudoService</a> provides the mechanism to run an arbitrary block of code, but changing the effective user executing the block, or the effective time that the block was run.</p>
</div>
<div class="paragraph">
<p>This is a general purpose capability, but is especially useful for fixtures.</p>
</div>
<div class="sect2">
<h3 id="mocking-the-clock"><a class="anchor" href="#mocking-the-clock"></a>Mocking the Clock</h3>
<div class="paragraph">
<p>It&#8217;s sometimes necessary to change the effective time that a fixture or test runs.
This can be done by calling <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html" class="xref page">SudoService</a> with an <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a> that has switched the clock.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">val when = VirtualClock.nowAt(Instant.parse("2017-02-03T09:00:00.00Z")); <i class="conum" data-value="1"></i><b>(1)</b>

simpleObject =
    sudoService.call(
        InteractionContext.switchClock(when),                            <i class="conum" data-value="2"></i><b>(2)</b>
        ()-&gt; fixtureScripts.runPersona(SimpleObject_persona.FOO)         <i class="conum" data-value="3"></i><b>(3)</b>
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the effective time, in other words the date/time we want the <a href="../../../refguide/latest/applib/index/services/clock/ClockService.html" class="xref page">ClockService</a> to report</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Unary operator on <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a> to switch the effective time</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the block of code to run within this modified <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="switching-the-user-sudo"><a class="anchor" href="#switching-the-user-sudo"></a>Switching the User ("Sudo")</h3>
<div class="paragraph">
<p>Sometimes in our fixture scripts we want to perform a business action running as a particular user.
This might be for the usual reason - so that our fixtures accurately reflect the reality of the system with all business constraints enforced using the <code>WrapperFactory</code> - or more straightforwardly it might be simply that the action depends on the identity of the user invoking the action.
Either way, this can be done by calling <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html" class="xref page">SudoService</a> with an <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a> that has switched the effective user.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">val who = UserMemento.ofName("fred");                            <i class="conum" data-value="1"></i><b>(1)</b>

simpleObject =
    sudoService.call(
        InteractionContext.switchUser(who),                      <i class="conum" data-value="2"></i><b>(2)</b>
        ()-&gt; fixtureScripts.runPersona(SimpleObject_persona.FOO) <i class="conum" data-value="3"></i><b>(3)</b>
    );</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the effective user, in other words the user that we want <a href="../../../refguide/latest/applib/index/services/user/UserService.html" class="xref page">UserService</a> to report</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Unary operator on <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a> to switch the effective user</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the block of code to run within this modified <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mocking-the-clock-and-the-user"><a class="anchor" href="#mocking-the-clock-and-the-user"></a>Mocking the Clock and the User</h3>
<div class="paragraph">
<p>If we want to change both the effective time <em>and</em> the effective user, then we just need to combine the <code>UnaryOperator</code>s passed into <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html" class="xref page">SudoService</a>.</p>
</div>
<div class="paragraph">
<p>As a convenience, <a href="../../../refguide/latest/applib/index/services/iactnlayer/InteractionContext.html" class="xref page">InteractionContext</a> provides a helper method for just this purpose:</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">val who = UserMemento.ofName("fred");
val when = VirtualClock.nowAt(Instant.parse("2017-02-03T09:00:00.00Z"));

val switchWhoAndWhen =
        InteractionContext.combine(
            InteractionContext.switchUser(who),
            InteractionContext.switchClock(when)
        );</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can then be passed in as the first argument to `SudoService&#8217;s <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html#call_UnaryOperator_Callable" class="xref page">call(&#8230;&#8203;)</a> or <a href="../../../refguide/latest/applib/index/services/sudo/SudoService.html#run_UnaryOperator_ThrowingRunnable" class="xref page">run(&#8230;&#8203;)</a> methods.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="article-aside toc hide-for-print" role="navigation">
    <p class="toc-title">On this page</p>
    <div id="article-toc"></div>
</aside>
</main>
</div>
<footer class="footer">
    <div class="content">
        <div class="copyright">
            <p>
                Copyright  2010~2024 The Apache Software Foundation, licensed under the Apache License, v2.0.
                <br/>
                Apache, the Apache feather logo, Apache Causeway, and the Apache Causeway project logo are all trademarks of The Apache Software Foundation.
            </p>
        </div>
        <div class="revision">
            <p>Revision: 4.0.0-SNAPSHOT.20251128-0303-3aa169fe</p>
        </div>
    </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/jquery-3.4.1.min.js"></script>
<script src="../../../_/js/vendor/jquery-ui-1.12.1.custom.widget-only.min.js"></script>
<script src="../../../_/js/vendor/jquery.tocify.min.js"></script>

<script>
    $(function() {
        $("#article-toc").tocify( {
            showEffect: "slideDown",
            hashGenerator: "pretty",
            hideEffect: "slideUp",
            selectors: "h2, h3",
            scrollTo: 120,
            smoothScroll: true,
            theme: "jqueryui",
            highlightOnScroll: true
        } );
    });
</script>

<script src="../../../_/js/vendor/docsearch.min.js"></script>
<script>
  function focusSearchInput () { document.querySelector('#algolia-search-input').focus() }
  var search = docsearch({
    appId: '5ISP5TFAEN',
    apiKey: '0fc51c28b4ad46e7318e96d4e97fab7c',
    indexName: 'causeway-apache-org',
    inputSelector: '#algolia-search-input',
    autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
    debug: false,
  }).autocomplete
  search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
  focusSearchInput()
  window.addEventListener('load', focusSearchInput);
</script>

<!--
  docsearch options:
  https://docsearch.algolia.com/docs/behavior/
-->
<!--
  https://www.algolia.com/doc/api-reference/api-parameters/
  algoliaOptions: { hitsPerPage: 6 },
-->
  </body>
</html>
