<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wrapper Factory :: Apache Isis</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/site-custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">
          <span class="icon">
            <img src="../../_/img/isis-logo-48x48.png"></img>
          </span>
        <span>Apache Isis</span>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <a class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Quick Start</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Starter Apps</span>
            <a class="navbar-item" href="../../starters/helloworld/about.html">Hello World</a>
            <a class="navbar-item" href="../../starters/simpleapp/about.html">Simple App</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Demos &amp; Tutorials</span>
            <a class="navbar-item" href="../../demoapp/about.html">Demo App</a>
            <a class="navbar-item" href="https://danhaywood.gitlab.io/isis-petclinic-tutorial-docs/petclinic/1.16.2/intro.html">Petclinic (tutorial)</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Core</span>
            <a class="navbar-item" href="../../userguide/about.html">User Guide</a>
            <a class="navbar-item" href="../../refguide/about.html">Reference Guide</a>
            <a class="navbar-item" href="../../testing/about.html">Testing Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Libraries</span>
            <a class="navbar-item" href="../../subdomain/about.html">Subdomain Libraries</a>
            <a class="navbar-item" href="../../valuetypes/about.html">Value Types</a>
            <a class="navbar-item" href="../../mappings/about.html">Bounded Context Mapping Libraries</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Resources</span>
            <a class="navbar-item" href="../../toc/devguide/about.html">Developers' Guide</a>
            <a class="navbar-item" href="../../toc/mavendeps/about.html">Maven dependencies</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Viewers</span>
            <a class="navbar-item" href="../../vw/about.html">Wicket UI</a>
            <a class="navbar-item" href="../../vro/about.html">Restful Objects (REST)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Security</span>
            <a class="navbar-item" href="../../security/about.html">Security Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Persistence</span>
            <a class="navbar-item" href="../../odn/about.html">DataNucleus Object Store</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Extensions</span>
            <a class="navbar-item" href="../../extensions/about.html">Extensions Catalog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Support</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Contact</span>
            <a class="navbar-item" href="../../toc/support/slack-channel.html">Slack</a>
            <a class="navbar-item" href="../../toc/support/mailing-list.html">Mailing Lists</a>
            <a class="navbar-item" href="https://issues.apache.org/jira/browse/ISIS">JIRA</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/isis">Stack Overflow</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Releases</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Releases</span>
            <a class="navbar-item" href="../../toc/downloads/how-to.html">Downloads</a>
            <a class="navbar-item" href="../../relnotes/about.html">Release Notes</a>
            <a class="navbar-item" href="../../mignotes/about.html">Migration Notes</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">More Libraries</span>
            <a class="navbar-item" href="../../incubator/about.html">Incubator</a>
            <a class="navbar-item" href="../../legacy/about.html">Legacy</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Internal</span>
            <a class="navbar-item" href="../../toc/comguide/about.html">Committers' Guide</a>
            <a class="navbar-item" href="../../core/about.html">Core Design</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">ASF</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="http://www.apache.org/">Apache Homepage</a>
            <a class="navbar-item" href="https://www.apache.org/events/current-event">Events</a>
            <a class="navbar-item" href="https://www.apache.org/licenses/">Licenses</a>
            <a class="navbar-item" href="https://www.apache.org/security/">Security</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <hr class="navbar-divider"/>
            <a class="navbar-item" href="https://whimsy.apache.org/board/minutes/Isis.html">PMC board minutes</a>
          </div>
        </div>
        <a class="navbar-item" href="../../toc/about.html">
          <span class="icon">
            <img src="../../_/img/home.png"></img>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body ">
<div class="nav-container" data-component="testing" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../about.html">Testing Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../unittestsupport/about.html">Unit Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="about.html">Integ Test Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../specsupport/about.html">BDD Spec Support (extension)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fixtures/about.html">Fixture Scripts (extension)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fakedata/about.html">Fakedata (extension)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../h2console/about.html">H2 Console</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../hsqldbmgr/about.html">HSQLDB Manager</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Testing Guide</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title"> </span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../toc/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">BC Mappings Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mappings/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Core Framework</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../core/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">DataNucleus ObjectStore</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../pjdo/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../extensions/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Incubator Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../incubator/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Legacy Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../legacy/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../refguide/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vro/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../security/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Starter Apps</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../starters/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Subdomains Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../subdomains/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Testing Guide</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Tutorial App - Demo</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../demoapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">User Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../userguide/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Value Types Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../valuetypes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vw/about.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../toc/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../about.html">Testing Guide</a></li>
    <li><a href="wrapper-factory.html">Wrapper Factory</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/apache/isis/edit/HEAD/testing/integtestsupport/adoc/modules/integtestsupport/pages/wrapper-factory.adoc">Edit</a></div>
</div>
<article class="doc">
    <a name="section-top"></a>
<h1 class="page">Wrapper Factory</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="../../refguide/applib-svc/application-layer-api/WrapperFactory.html" class="page"><code>WrapperFactory</code></a> service is responsible for wrapping a domain object in a dynamic proxy, of the same type as the object being proxied.
And the role of this wrapper is to simulate the UI.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>WrapperFactory</code> uses <a href="http://www.javassist.org">javassist</a> to perform its magic; this is the same technology that ORMs such as <a href="http://hibernate.org/">Hibernate</a> use to manage lazy loading/dirty tracking (DataNucleus uses a different mechanism).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It does this by allowing through method invocations that would be allowed if the user were interacting with the domain object through one of the viewers, but throwing an exception if the user attempts to interact with the domain object in a way that would not be possible if using the UI.</p>
</div>
<div class="paragraph">
<p>The mechanics are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the integration test calls the <code>WrapperFactory</code> to obtain a wrapper for the domain object under test.
This is usually done in the test&#8217;s <code>setUp()</code> method.</p>
</li>
<li>
<p>the test calls the methods on the wrapper rather than the domain object itself</p>
</li>
<li>
<p>the wrapper performs a reverse lookup from the method invoked (a regular <code>java.lang.reflect.Method</code> instance) into the Apache Isis metamodel</p>
</li>
<li>
<p>(like a viewer), the wrapper then performs the "see it/use it/do it" checks, checking that the member is visible, that it is enabled and (if there are arguments) that the arguments are valid</p>
</li>
<li>
<p>if the business rule checks pass, then the underlying member is invoked.
Otherwise an exception is thrown.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The type of exception depends upon what sort of check failed.
It&#8217;s straightforward enough: if the member is invisible then a <code>HiddenException</code> is thrown; if it&#8217;s not usable then you&#8217;ll get a <code>DisabledException</code>, if the args are not valid then catch an <code>InvalidException</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/wrapper-factory.png"><img src="_images/wrapper-factory.png" alt="wrapper factory" width="600px"></a>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look in a bit more detail at what the test can do with the wrapper.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrapping-and-unwrapping"><a class="anchor" href="#wrapping-and-unwrapping"></a>Wrapping and Unwrapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wrapping a domain object is very straightforward; simply call <code>WrapperFactory#wrap(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Customer customer = ...;
Customer wrappedCustomer = wrapperFactory.wrap(wrappedCustomer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going the other way&#8201;&#8212;&#8201;getting hold of the underlying (wrapped) domain object&#8201;&#8212;&#8201;is just as easy; just call <code>WrapperFactory#unwrap(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Customer wrappedCustomer = ...;
Customer customer = wrapperFactory.unwrap(wrappedCustomer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer, you also can get the underlying object from the wrapper itself, by downcasting to <code>WrappingObject</code> and calling <code>__isis_wrapped()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Customer wrappedCustomer = ...;
Customer customer = (Customer)((WrappingObject)wrappedCustomer).__isis_wrapped());</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re not sure that&#8217;s any easier (in fact we&#8217;re certain it looks rather obscure).  Stick with calling <code>unwrap(&#8230;&#8203;)</code>!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-wrapper"><a class="anchor" href="#using-the-wrapper"></a>Using the wrapper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the wrapper is intended to simulate the UI, only those methods that correspond to the "primary" methods of the domain object&#8217;s members are allowed to be called.
That means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for <strong><em>object properties</em></strong> the test can call the getter or setter method</p>
</li>
<li>
<p>for <strong><em>object collections</em></strong> the test can call the getter.</p>
<div class="paragraph">
<p>If there is a supporting <code>addTo&#8230;&#8203;()</code> or <code>removeFrom&#8230;&#8203;()</code> method, then these can be called.
It can also call <code>add(&#8230;&#8203;)</code> or <code>remove(&#8230;&#8203;)</code> on the collection (returned by the gettter) itself.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this respect the wrapper is more functional than the <a href="../../vw/about.html" class="page">Wicket viewer</a> (which does not expose the ability to mutate collections directly).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>for <strong><em>object actions</em></strong> the test can call the action method itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a convenience, we also allow the test to call any <code>default&#8230;&#8203;()</code>,<code>choices&#8230;&#8203;()</code> or <code>autoComplete&#8230;&#8203;()</code> method.
These are often useful for obtaining a valid value to use.</p>
</div>
<div class="paragraph">
<p>What the test can&#8217;t call is any of the remaining supporting methods, such as <code>hide&#8230;&#8203;()</code>, <code>disable&#8230;&#8203;()</code> or <code>validate&#8230;&#8203;()</code>.
That&#8217;s because their value is implied by the exception being thrown.</p>
</div>
<div class="paragraph">
<p>The wrapper <em>does</em> also allow the object&#8217;s <code>title()</code> method or its  <code>toString()</code> , however this is little use for objects whose title is built up using the <code>@Title</code> annotation.
Instead, we recommend that your test verifies an object&#8217;s title by calling <code>TitleService#titleOf(&#8230;&#8203;)</code> method.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="firing-domain-events"><a class="anchor" href="#firing-domain-events"></a>Firing Domain Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As well as enforcing business rules, the wrapper has another important feature, namely that it will cause domain events to be fired.</p>
</div>
<div class="paragraph">
<p>For example, if we have an action annotated with <code>@Action(domainEvent=&#8230;&#8203;</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ToDoItem ... {
    @Action(
            domainEvent =CompletedEvent.class
    )
    public ToDoItem completed() { /* ... */ }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>then invoking the action through the proxy will cause the event (<code>CompletedEvent</code> above) to be fired to any subscribers.
A test might therefore look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SomeIntegratTest /* ... */ {
    @Inject
    private EventBusService eventBusService;                                       <i class="conum" data-value="1"></i><b>(1)</b>

    @Test
    public void subscriberReceivesEvents() {

        // given
        final ToDoItem.CompletedEvent[] evHolder = new ToDoItem.CompletedEvent[1]; <i class="conum" data-value="2"></i><b>(2)</b>
        eventBusService.register(new Object() {
            @org.springframework.context.event.EventListener(ToDoItem.CompletedEvent.class)
            public void on(final ToDoItem.CompletedEvent ev) {                     <i class="conum" data-value="3"></i><b>(3)</b>
                evHolder[0] = ev;
            }
        });

        // when
        toDoItem.completed();                                                      <i class="conum" data-value="4"></i><b>(4)</b>

        // then
        then(evHolder[0].getSource()).isEqualTo(unwrap(toDoItem));                 <i class="conum" data-value="5"></i><b>(5)</b>
        then(evHolder[0].getIdentifier().getMemberName()).isEqualTo("completed");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inject <a href="../../refguide/applib-svc/core-domain-api/EventBusService.html" class="page"><code>EventBusService</code></a> into this test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>holder for subscriber to capture event to</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>subscriber&#8217;s callback, using Spring events</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>invoking the domain object using the wrapper</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>assert that the event was populated</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The wrapper will also fire domain events for properties (if annotated with <code>@Property(domainEvent=&#8230;&#8203;)</code>) or collections (if annotated with <code>@Collection(domainEvent=&#8230;&#8203;)</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It isn&#8217;t possible to use the <code>WrapperFactory</code> in a unit test, because there needs to be a running instance of Apache Isis that holds the metamodel.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
<aside class="article-aside toc" role="navigation">
    <p class="toc-title">On this page</p>
    <div id="article-toc"></div>
</aside>
</main>
</div>
<footer class="footer">
    <div class="content">
        <div class="copyright">
            <p>
                Copyright © 2010~2019 The Apache Software Foundation, licensed under the Apache License, v2.0.
                <br/>
                Apache, the Apache feather logo, Apache Isis, and the Apache Isis project logo are all trademarks of The Apache Software Foundation.
            </p>
        </div>
        <div class="revision">
            <p>Revision: 2.0.0-M2.20200116-0401-e7eaa3c4</p>
        </div>
    </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/jquery-3.4.1.min.js"></script>
<script src="../../_/js/vendor/jquery-ui-1.12.1.custom.widget-only.min.js"></script>
<script src="../../_/js/vendor/jquery.tocify.min.js"></script>

<script>
    $(function() {
        $("#article-toc").tocify( {
            showEffect: "slideDown",
            hideEffect: "slideUp",
            scrollTo: 120,
            smoothScroll: true,
            theme: "jqueryui",
            highlightOnScroll: true
        } );
    });
</script>
  </body>
</html>
