<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>View Model Instantiation :: Apache Isis</title>
    <link rel="canonical" href="https://isis.apache.org/ug/btb/hints-and-tips/view-model-instantiation.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://isis.apache.org">Apache Isis</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ug" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../about.html">Fundamentals &amp; Beyond</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../about.html">About</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../fun/about.html">Fundamentals</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/core-concepts.html">Core Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/building-blocks.html">Building Blocks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/programming-model.html">Programming Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/ui-hints.html">UI Hints</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/crud.html">CRUD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/business-rules.html">Business Rules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/drop-downs-and-defaults.html">Drop downs and Defaults</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../fun/available-domain-services.html">Available Domain Services</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../about.html">Beyond the Basics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../i18n.html">i18n</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../headless-access.html">Headless Access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hints-and-tips.html">Hints-n-Tips</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../programming-model.html">Programming Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment.html">Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../web-xml.html">web.xml</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Fundamentals &amp; Beyond</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Architecture & Design</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../archdesign/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">DataNucleus ObjectStore</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../odn/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Demo</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../demoapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - Hello World</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../helloworld/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Example App - SimpleApp</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../simpleapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions - SecMan</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ext-secman/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Fundamentals & Beyond</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Guides - Reference Guides</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../rg/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Maven Dependencies</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mavendeps/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Migration Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mignotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Release Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../relnotes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../vro/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Runtime Services</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../runtime-services/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../security/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">SmokeTest App</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../smoketests/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Table of Contents</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../toc/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Testing</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../testing/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../vw/about.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../toc/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../about.html">Fundamentals & Beyond</a></li>
    <li><a href="view-model-instantiation.html">View Model Instantiation</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/hobrom/antora/isis/antora/components/userguide/modules/btb/pages/hints-and-tips/view-model-instantiation.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">View Model Instantiation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Vith view models, some care must be taken in how they are instantiated.
Specifically, it&#8217;s important that the framework doesn&#8217;t "know" about the view model until its state is "sufficiently" populated to distinguish from other view models.</p>
</div>
<div class="paragraph">
<p>In practical terms, this means that view models should be instantiated using a constructor, and then injecting services (if required) using the <a href="../../../rg/svc/metadata-api/ServiceRegistry.html" class="page"><code>ServiceRegistry</code></a> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CustomerViewModel viewModel = new CustomerViewModel("Joe", "Bloggs");
serviceRegistry.injectServicesInto(viewModel);</code></pre>
</div>
</div>
<div class="paragraph">
<p>What will most likely <strong>fail</strong> is to use the <a href="../../../rg/svc/core-domain-api/FactoryService.html" class="page"><code>FactoryService</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// DON'T DO THIS WITH VIEW MODELS
CustomerViewModel viewModel = factoryService.instantiate(CustomerViewModel.class);

viewModel.setFirstName("Joe");
viewModel.setLastName("Bloggs");
serviceRegistry.injectServicesInto(viewModel);</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s because the internal "OID" identifier that the framework creates to handle this view model will be incomplete.
Although the framework can handle changes to the OID (when the corresponding view model&#8217;s state changes) once created, this isn&#8217;t the case during initial instantiation process.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example"><a class="anchor" href="#example"></a>Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To explain further, here&#8217;s an implementation using <code>FactoryService</code> that fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@XmlRootElement(name = "yearSummary")
@XmlType( propOrder = { /* ... */ } )
@XmlAccessorType(XmlAccessType.FIELD)
public class YearSummary {                                                  <i class="conum" data-value="1"></i><b>(1)</b>
    ...
    @XmlTransient
    @CollectionLayout(defaultView = "table")
    public List&lt;OfficeOptionViewModel&gt; getAmountsPerOffice() {
        List&lt;OfficeOptionViewModel&gt; amountsPerOffice = new ArrayList&lt;&gt;();

        OfficeOptionViewModel office1 =                                     <i class="conum" data-value="2"></i><b>(2)</b>
            factoryService.instantiate(OfficeOptionViewModel.class);
        office1.setOffice("Amsterdam");                                     <i class="conum" data-value="3"></i><b>(3)</b>
        office1.setAmount(200);
        amountsPerOffice.add(office1);

        OfficeOptionViewModel office2 =                                     <i class="conum" data-value="2"></i><b>(2)</b>
            factoryService.instantiate(OfficeOptionViewModel.class);
        office2.setOffice("London");                                        <i class="conum" data-value="3"></i><b>(3)</b>
        office2.setAmount(100);
        amountsPerOffice.add(office2);

        return amountsPerOffice;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Parent view model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using <code>FactoryService</code>, incorrectly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hard-coded just for demo purposes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This collection, is, confusing, rendered as:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/hints-and-tips/view-model-fail.png"><img src="../_images/hints-and-tips/view-model-fail.png" alt="view model fail" width="800px"></a>
</div>
</div>
<div class="paragraph">
<p>Even though the <code>amountsPerOffice</code> collection of view models is correctly populated, the framework/viewer maps these to their corresponding OIDs before they are rendered.
Because the "Amsterdam" pojo and "London" pojo each mapped to the same OID, when fetching out the results the viewer obtains the London pojo both times.</p>
</div>
<div class="paragraph">
<p>The following implementation, on the other hand, succeeds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@XmlRootElement(name = "yearSummary")
@XmlType( propOrder = { /* ... */ } )
@XmlAccessorType(XmlAccessType.FIELD)
public class YearSummary {
    ...
    @XmlTransient
    @CollectionLayout(defaultView = "table")
    public List&lt;OfficeOptionViewModel&gt; getAmountsPerOffice() {
        List&lt;OfficeOptionViewModel&gt; amountsPerOffice = new ArrayList&lt;&gt;();

		OfficeOptionViewModel office1 = new OfficeOptionViewModel("Amsterdam", 200);    <i class="conum" data-value="1"></i><b>(1)</b>
		serviceRegistry.injectServicesInto(office1);
		amountsPerOffice.add(office1);

		OfficeOptionViewModel office2 = new OfficeOptionViewModel("London", 100);       <i class="conum" data-value="1"></i><b>(1)</b>
		serviceRegistry.injectServicesInto(office2);
		amountsPerOffice.add(office2);

        return amountsPerOffice;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Just instantiate with constructor.
The framework "sees" the domain object when services are injected into it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As can be seen, this renders just fine:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="../_images/hints-and-tips/view-model-success.png"><img src="../_images/hints-and-tips/view-model-success.png" alt="view model success" width="800px"></a>
</div>
</div>
<div class="paragraph">
<p>To complicate matters a little, note though that following "incorrect" implementation using <code>FactoryService</code> does also work correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@XmlRootElement(name = "yearSummary")
@XmlType( propOrder = { ..., "amountsPerOffice" } )                     <i class="conum" data-value="1"></i><b>(1)</b>
@XmlAccessorType(XmlAccessType.FIELD)
public class YearSummary {
	...

    void init() {
        amountsPerOffice = calculateAmountsPerOffice();
    }

    @XmlElementWrapper
    @XmlElement(name = "officeOption")
    @CollectionLayout(defaultView = "table")
    @Getter @Setter
    private List&lt;OfficeOptionViewModel&gt; amountsPerOffice = Lists.newArrayList();

	@XmlTransient
    @CollectionLayout(defaultView = "table")
    public List&lt;OfficeOptionViewModel&gt; calculateAmountsPerOffice() {
        List&lt;OfficeOptionViewModel&gt; amountsPerOffice = new ArrayList&lt;&gt;();

		OfficeOptionViewModel office1 = factoryService.instantiate(OfficeOptionViewModel.class);
		office1.setOffice("Amsterdam");
		office1.setAmount(200);

		amountsPerOffice.add(office1);

		OfficeOptionViewModel office2 = factoryService.instantiate(OfficeOptionViewModel.class);
		office2.setOffice("London");
		office2.setAmount(100);

		amountsPerOffice.add(office2);

        return amountsPerOffice;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>"amountsPerOffice" is part of the state of the parent view model</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case the <code>amountsPerOffice</code> collection is part of the state of the parent view model and so in this particular case everything works with either <code>FactoryService#instantiate</code> or using <code>ServiceRegistry</code>.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
