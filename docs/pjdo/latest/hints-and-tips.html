<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hints and Tips :: Apache Isis</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/site-custom.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Raleway:300,400,500,700,800|Montserrat:300,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>
<link rel="home" href="../.." title="Apache Isis">
  <link rel="next" href="services/IsisJdoSupport.html" title="IsisJdoSupport">
  <link rel="prev" href="db-schemas.html" title="DB Schemas">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">
          <span class="icon">
            <img src="../../_/img/isis-logo-48x48.png"></img>
          </span>
        <span>Apache Isis</span>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <a class="navbar-end">
        <div class="navbar-item hide-for-print">
          <span>
            <input id="algolia-search-input" placeholder="Search"></span>
          </span>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Quick Start</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Starter Apps</span>
            <a class="navbar-item" href="../../docs/2.0.0-M5/starters/helloworld.html">Hello World</a>
            <a class="navbar-item" href="../../docs/2.0.0-M5/starters/simpleapp.html">Simple App</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Demos &amp; Tutorials</span>
            <a class="navbar-item" href="../../docs/2.0.0-M5/demo/about.html">Demo App</a>
            <a class="navbar-item" href="https://danhaywood.gitlab.io/isis-petclinic-tutorial-docs/petclinic/1.16.2/intro.html">Petclinic (tutorial)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Resources</span>
            <a class="navbar-item" href="../../docs/2.0.0-M5/resources/cheatsheet.html">Cheatsheet</a>
            <a class="navbar-item" href="../../docs/2.0.0-M5/resources/icons.html">Icons</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Development</span>
            <a class="navbar-item" href="../../setupguide/2.0.0-M5/about.html">Setup Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Core</span>
            <a class="navbar-item" href="../../userguide/2.0.0-M5/about.html">User Guide</a>
            <a class="navbar-item" href="../../refguide/2.0.0-M5/about.html">Reference Guide</a>
            <a class="navbar-item" href="../../testing/2.0.0-M5/about.html">Testing Guide</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Libraries</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">For Use in Apps</span>
            <a class="navbar-item" href="../../subdomains/2.0.0-M5/about.html">Subdomain Libraries</a>
            <a class="navbar-item" href="../../valuetypes/2.0.0-M5/about.html">Value Types</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Integrate between Apps</span>
            <a class="navbar-item" href="../../mappings/2.0.0-M5/about.html">Bounded Context Mapping Libraries</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Other</span>
            <a class="navbar-item" href="../../incubator/2.0.0-M5/about.html">Incubator</a>
            <a class="navbar-item" href="../../legacy/2.0.0-M5/about.html">Legacy</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Viewers</span>
            <a class="navbar-item" href="../../vw/2.0.0-M5/about.html">Wicket UI</a>
            <a class="navbar-item" href="../../vro/2.0.0-M5/about.html">Restful Objects (REST)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Security</span>
            <a class="navbar-item" href="../../security/2.0.0-M5/about.html">Security Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Persistence</span>
            <a class="navbar-item" href="../../pjdo/2.0.0-M5/about.html">DataNucleus (JDO)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Extensions</span>
            <a class="navbar-item" href="../../extensions/2.0.0-M5/about.html">Extensions Catalog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Support</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Contact</span>
            <a class="navbar-item" href="../../docs/2.0.0-M5/support/slack-channel.html">Slack</a>
            <a class="navbar-item" href="../../docs/2.0.0-M5/support/mailing-list.html">Mailing Lists</a>
            <a class="navbar-item" href="https://issues.apache.org/jira/browse/ISIS">JIRA</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/isis">Stack Overflow</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Releases</span>
            <a class="navbar-item" href="../../docs/2.0.0-M5/downloads/how-to.html">Downloads</a>
            <a class="navbar-item" href="../../relnotes/2.0.0-M5/about.html">Release Notes</a>
            <a class="navbar-item" href="../../docs/2.0.0-M5/archive/1-x.html">Archive (1.x)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Framework</span>
            <a class="navbar-item" href="../../conguide/2.0.0-M5/about.html">Contributors' Guide</a>
            <a class="navbar-item" href="../../comguide/2.0.0-M5/about.html">Committers' Guide</a>
            <a class="navbar-item" href="../../core/2.0.0-M5/about.html">Core Design</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">ASF</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="http://www.apache.org/">Apache Homepage</a>
            <a class="navbar-item" href="https://www.apache.org/events/current-event">Events</a>
            <a class="navbar-item" href="https://www.apache.org/licenses/">Licenses</a>
            <a class="navbar-item" href="https://www.apache.org/security/">Security</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <hr class="navbar-divider"/>
            <a class="navbar-item" href="https://whimsy.apache.org/board/minutes/Isis.html">PMC board minutes</a>
          </div>
        </div>
        <a class="navbar-item" href="../../docs/2.0.0-M5/about.html">
          <span class="icon">
            <img src="../../_/img/home.png"></img>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body ">
<div class="nav-container" data-component="pjdo" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-pagination">
  <a class="page-previous" rel="prev" href="db-schemas.html" title="DB Schemas"><span></span></a>
  <a class="page-next" rel="next"
     href="services/IsisJdoSupport.html" title="IsisJdoSupport"><span></span></a>
<!--
page.parent doesn't seem to be set...
  <a class="page-parent disabled" rel="prev" href="" title="DB Schemas"><span></span></a>
-->
</div>
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="about.html">JDO/DataNucleus</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="configuring.html">Configuring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jdo-mappings.html">JDO Mappings</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="db-schemas.html">DB Schemas</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="hints-and-tips.html">Hints-n-Tips</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Domain Services</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="services/IsisJdoSupport.html">IsisJdoSupport</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">JDO/DataNucleus</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title"> </span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">BC Mappings Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mappings/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Committers' Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../comguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Contributors' Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../conguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Design Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../core/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../extensions/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Incubator Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../incubator/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">JDO/DataNucleus</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Legacy Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../legacy/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../refguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Release Notes</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../relnotes/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vro/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../security/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Setup Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../setupguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Subdomains Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../subdomains/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Testing Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../testing/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Tooling</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../tooling/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">User Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../userguide/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Value Types Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../valuetypes/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vw/latest/about.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../docs/latest/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="about.html">JDO/DataNucleus</a></li>
    <li><a href="hints-and-tips.html">Hints-n-Tips</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/apache/isis/edit/master/persistence/jdo/adoc/modules/ROOT/pages/hints-and-tips.adoc">Edit</a></div>
</div>
<article class="doc">
    <a name="section-top"></a>
<h1 class="page">Hints and Tips</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
TODO: this content has not yet been reviewed/updated for v2.0
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This chapter provides some solutions for problems we&#8217;ve encountered ourselves or have been raised on the Apache Isis mailing lists.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overriding-jdo-annotations"><a class="anchor" href="#overriding-jdo-annotations"></a>Overriding JDO Annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JDO/DataNucleus builds its own persistence metamodel by reading both annotations on the class and also by searching for metadata in XML files.
The metadata in the XML files takes precedence over the annotations, and so can be used to override metadata that is "hard-coded" in annotations.</p>
</div>
<div class="paragraph">
<p>In fact, JDO/DataNucleus provides two different XML files that have slightly different purposes and capabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>first, a <code>.jdo</code> file can be provided which - if found - completely replaces the annotations.<br></p>
<div class="paragraph">
<p>The idea here is simply to use XML as the means by which metadata is specified.</p>
</div>
</li>
<li>
<p>second, an <code>.orm</code> file can be provided which - if found - provides individual overrides for a particular database vendor.<br></p>
<div class="paragraph">
<p>The idea here is to accommodate for subtle differences in support for SQL between vendors.
A good example is the default schema for a table: <code>dbo</code> for SQL Server, <code>public</code> for HSQLDB, <code>sys</code> for Oracle, and so on.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want to use the first approach (the <code>.jdo</code> file), you&#8217;ll find that you can download the effective XML representation of domain entities using the <a href="#refguide:applib-cm:classes.adoc#downloadJdoMetadata" class="page unresolved">downloadJdoMetadata()</a> mixin action available in prototyping mode.
This then needs to be renamed and placed in the appropriate location on the classpath; see the <a href="http://www.datanucleus.org">DataNucleus documentation</a> for details.</p>
</div>
<div class="paragraph">
<p>However, using this first approach does create a maintenance effort; if the domain entity&#8217;s class structure changes over time, then the XML metadata file will need to be updated.</p>
</div>
<div class="paragraph">
<p>The second approach (using an <code>.orm</code> file) is therefore often more useful than the first, because the metadata provided overrides rather than replaces the annotations (and annotations not overridden continue to be honoured).</p>
</div>
<div class="paragraph">
<p>A typical use case is to change the database schema for an entity.
For example, various extension modules use schemas for each entity.
For example, the <code>AuditEntry</code> entity in the <a href="../../security/latest/audit-trail/about.html" class="page">audit trail</a> security module is annotated as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@javax.jdo.annotations.PersistenceCapable(
        identityType=IdentityType.DATASTORE,
        schema = "IsisAddonsAudit",
        table="AuditEntry")
public class AuditEntry {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will map the <code>AuditEntry</code> class to a table <code>&quot;IsisAddonsAudit&quot;.&quot;AuditEntry&quot;</code>; that is using a custom schema to own the object.</p>
</div>
<div class="paragraph">
<p>Suppose though that for whatever reason we didn&#8217;t want to use a custom schema but would rather use the default.
Also suppose we are using SQL Server as our target database.</p>
</div>
<div class="paragraph">
<p>We can override the above annotation using a <code>AuditEntry-sqlserver.orm</code> file, placed in the same package as the <code>AuditEntry</code> entity.
For example:</p>
</div>
<div class="listingblock">
<div class="title">AuditEntry-sqlserver.orm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;orm xmlns="http://xmlns.jcp.org/xml/ns/jdo/orm"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/jdo/orm
        http://xmlns.jcp.org/xml/ns/jdo/orm_3_0.xsd"&gt;

    &lt;package name="org.isisaddons.module.audit.dom"&gt;
        &lt;class name="AuditEntry"
               schema="isisaudit"
               table="AuditEntry"&gt;
        &lt;/class&gt;
    &lt;/package&gt;
&lt;/orm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also necessary to tell JDO/DataNucleus about which vendor is being used (<code>sqlserver</code> in the example above).
This is done using the pass-thru <code>datanucleus.Mapping</code> configuration property:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">datanucleus.Mapping=sqlserver</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subtype-entity-not-fully-populated"><a class="anchor" href="#subtype-entity-not-fully-populated"></a>Subtype not fully populated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Taken from <a href="http://markmail.org/message/ovgai56uqgfgnrx7">this thread</a> on the Apache Isis users mailing list&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>If it seems that Apache Isis (or rather DataNucleus) isn&#8217;t fully populating domain entities (ie leaving some properties as <code>null</code>), then check that your actions are not accessing the fields directly.
Use getters instead.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Properties of domain entities should always be accessed using getters.
The only code that should access to fields should be the getters themselves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Why so?
Because DataNucleus will potentially lazy load some properties, but to do this it needs to know that the field is being requested.
This is the purpose of the enhancement phase: the bytecode of the original getter method is actually wrapped in code that does the lazy loading checking.
But hitting the field directly means that the lazy loading code does not run.</p>
</div>
<div class="paragraph">
<p>This error can be subtle: sometimes "incorrect" code that accesses the fields will seem to work.
But that will be because the field has been populated already, for whatever reason.</p>
</div>
<div class="paragraph">
<p>One case where you will find the issue highlighted is for subtype tables that have been mapped using an inheritance strategy of <code>NEW_TABLE</code>, eg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@javax.jdo.annotations.PersistenceCapable
@javax.jdo.annotations.Inheritance(strategy = InheritanceStrategy.NEW_TABLE)
public class SupertypeEntity {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@javax.jdo.annotations.PersistenceCapable
@javax.jdo.annotations.Inheritance(strategy = InheritanceStrategy.NEW_TABLE)
public class SubtypeEntity extends SupertypeEntity {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate two tables in the database, with the primary key of the supertype table propagated as a foreign key (also primary key) of the subtype table (sometimes called "table per type" strategy).
This means that DataNucleus might retrieve data from only the supertype table, and the lazily load the subtype fields only as required.
This is preferable to doing a left outer join from the super- to the subtype tables to retrieve data that might not be needed.</p>
</div>
<div class="paragraph">
<p>On the other hand, if the <code>SUPERCLASS_TABLE</code> strategy (aka "table per hierarchy" or roll-up) or the <code>SUBCLASS_TABLE</code> strategy (roll-down) was used, then the problem is less likely to occur because DataNucleus would obtain all the data for any given instance from a single table.</p>
</div>
<div class="paragraph">
<p>Final note: references to other objects (either scalar references or in collections) in particular require that getters rather than fields to be used to obtain them: it&#8217;s hopefully obvious that DataNucleus (like all ORMs) should not and will not resolve such references (otherwise, where to stop&#8230;&#8203; and the whole database would be loaded into memory).</p>
</div>
<div class="paragraph">
<p>In summary, there&#8217;s just one rule: <strong>always use the getters, never the fields</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="java8"><a class="anchor" href="#java8"></a>Java8</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
TODO: v2: should probably just remove this section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>DataNucleus 4.x supports Java 7, but can also be used with Java 8, eg for streams support against collections managed
by DataNucleus.</p>
</div>
<div class="paragraph">
<p>Just include within <code>&lt;dependencies&gt;</code> of your <code>dom</code> module&#8217;s <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.datanucleus&lt;/groupId&gt;
    &lt;artifactId&gt;datanucleus-java8&lt;/artifactId&gt;
    &lt;version&gt;4.2.0-release&lt;/version&gt;t
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The DataNucleus website includes a <a href="http://www.datanucleus.org/products/accessplatform/compatibility.html">page</a>
listing version compatibility of these extensions vis-a-vis the core DataNucleus platform.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="diagnosing-n-plus-1"><a class="anchor" href="#diagnosing-n-plus-1"></a>Diagnosing n+1 Issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(As of DN 4.1) set a break point in <code>FetchRequest#execute(&#8230;&#8203;)</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hints-n-tips/diagnosing-n-plus-1.png" alt="diagnosing n plus 1" width="800px">
</div>
</div>
<div class="paragraph">
<p>The "Variables" pane will tell you which field(s) are being loaded, and the stack trace should help explain why the field is required.</p>
</div>
<div class="paragraph">
<p>For example, it may be that an object is being loaded in a table and the initial query did not eagerly load that field.
In such a case, consider using fetch groups in the initial repository query to bring the required data into memory with just one SQL call.
See <a href="#typesafe-queries-and-fetchgroups">this hint/tip</a> for further details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="typesafe-queries-and-fetchgroups"><a class="anchor" href="#typesafe-queries-and-fetchgroups"></a>Typesafe Queries and Fetch-groups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fetch groups provide a means to hint to DataNucleus that it should perform a SQL join when querying.
A common use case is to avoid the <a href="#diagnosing-n-plus-1">n+1</a> issue.</p>
</div>
<div class="paragraph">
<p>(So far as I could ascertain) it isn&#8217;t possible to specify fetch group hints using JDOQL, but it is possible to specify them using the programmatic API or using typesafe queries.</p>
</div>
<div class="paragraph">
<p>For example, here&#8217;s a JDOQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Query(
		name = "findCompletedOrLaterWithItemsByReportedDate", language = "JDOQL",
		value = "SELECT "
				+ "FROM org.estatio.capex.dom.invoice.IncomingInvoice "
				+ "WHERE items.contains(ii) "
				+ "   &amp;&amp; (ii.reportedDate == :reportedDate) "
				+ "   &amp;&amp; (approvalState != 'NEW' &amp;&amp; approvalState != 'DISCARDED') "
				+ "VARIABLES org.estatio.capex.dom.invoice.IncomingInvoiceItem ii "
),
public class IncomingInvoice ... { /* ... */ }</code></pre>
</div>
</div>
<div class="paragraph">
<p>which normally would be used from a repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public List&lt;IncomingInvoice&gt; findCompletedOrLaterWithItemsByReportedDate(
        final LocalDate reportedDate) {
    return repositoryService.allMatches(
            new QueryDefault&lt;&gt;(
                    IncomingInvoice.class,
                    "findCompletedOrLaterWithItemsByReportedDate",
                    "reportedDate", reportedDate));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be re-written as a type-safe query as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public List&lt;IncomingInvoice&gt; findCompletedOrLaterWithItemsByReportedDate(final LocalDate reportedDate) {

    final QIncomingInvoice ii = QIncomingInvoice.candidate();
    final QIncomingInvoiceItem iii = QIncomingInvoiceItem.variable("iii");

    final TypesafeQuery&lt;IncomingInvoice&gt; q =
        isisJdoSupport.newTypesafeQuery(IncomingInvoice.class);

    q.filter(
            ii.items.contains(iii)
        .and(iii.reportedDate.eq(reportedDate))
        .and(ii.approvalState.ne(IncomingInvoiceApprovalState.NEW))
        .and(ii.approvalState.ne(IncomingInvoiceApprovalState.DISCARDED)));
    final List&lt;IncomingInvoice&gt; incomingInvoices = Lists.newArrayList(q.executeList());
    q.closeAll();
    return incomingInvoices;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the <code>IncomingInvoice</code> has four fields that require eager loading.
This can be specified by defining a named fetch group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@FetchGroup(
        name="seller_buyer_property_bankAccount",
        members={
                @Persistent(name="seller"),
                @Persistent(name="buyer"),
                @Persistent(name="property"),
                @Persistent(name="bankAccount")
        })
public class IncomingInvoice ... { /* ... */ }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This fetch group can then be used in the query using <code>q.getFetchPlan().addGroup(&#8230;&#8203;)</code>.
Putting this all together, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public List&lt;IncomingInvoice&gt; findCompletedOrLaterWithItemsByReportedDate(final LocalDate reportedDate) {

    final QIncomingInvoice ii = QIncomingInvoice.candidate();
    final QIncomingInvoiceItem iii = QIncomingInvoiceItem.variable("iii");

    final TypesafeQuery&lt;IncomingInvoice&gt; q =
        isisJdoSupport.newTypesafeQuery(IncomingInvoice.class);

    q.getFetchPlan().addGroup("seller_buyer_property_bankAccount");     <i class="conum" data-value="1"></i><b>(1)</b>

    q.filter(
            ii.items.contains(iii)
        .and(iii.reportedDate.eq(reportedDate))
        .and(ii.approvalState.ne(IncomingInvoiceApprovalState.NEW))
        .and(ii.approvalState.ne(IncomingInvoiceApprovalState.DISCARDED)));
    final List&lt;IncomingInvoice&gt; incomingInvoices = Lists.newArrayList(q.executeList());
    q.closeAll();
    return incomingInvoices;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>specify the fetch group to use.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jdoql-and-timestamps"><a class="anchor" href="#jdoql-and-timestamps"></a>JDOQL and Timestamps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beware of entities with a property called "timestamp": you run the risk of "timestamp" being treated as a keyword in certain contexts, probably not as you intended.</p>
</div>
<div class="paragraph">
<p>By way of example, the <a href="../../extensions/latest/command-log/about.html" class="page">Command Log</a> module has an entity called <code>CommandJdo</code>.
This has a property called "timestamp", of type <code>java.sql.Timestamp</code>.</p>
</div>
<div class="paragraph">
<p>This defines a query using JDOQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SELECT
FROM org.isisaddons.module.command.dom.CommandJdo
WHERE executeIn == 'FOREGROUND'
   &amp;&amp; timestamp &gt; :timestamp
   &amp;&amp; startedAt != null
   &amp;&amp; completedAt != null
ORDER BY timestamp ASC</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is declared using a JDO <code>@Query</code>; no errors are thrown at any stage.</p>
</div>
<div class="paragraph">
<p>However, running this query against SQL Server 2016 produced a different result first time it was run compared to subsequent times.</p>
</div>
<div class="paragraph">
<p>Running SQL Profiler showed the underlying SQL as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">exec sp_prepexec @p1 output,N'@P0 datetime2',
N'SELECT ''org.isisaddons.module.command.dom.CommandJdo'' AS NUCLEUS_TYPE,
  A0.arguments,
  ...,
  A0.target,
  A0."timestamp",
  A0.transactionId,
  A0."user",
  ''2018-01-24 17:29:18.3'' AS NUCORDER0    <i class="conum" data-value="1"></i><b>(1)</b>
FROM isiscommand.Command A0
WHERE A0.executeIn = ''FOREGROUND''
  AND A0."timestamp" &gt; @P0
  AND A0.startedAt IS NOT NULL
  AND A0.completedAt IS NOT NULL
  ORDER BY NUCORDER0
  OFFSET 0 ROWS FETCH NEXT 2 ROWS ONLY ',   <i class="conum" data-value="2"></i><b>(2)</b>
'2018-01-24 17:29:18.3000000'               <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>discussed below &#8230;&#8203; this is the issue</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>because the query is submitted with max rows programmatically set to 2.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>argument for @P0 (the timestamp parametr)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To unpick this, the key issue is the <code>NUCORDER0</code> column, which is then used in the <code>ORDER BY</code>.
However, because this is a literal value, the effect is no defined ordering.</p>
</div>
<div class="paragraph">
<p>The problem therefore is that in the JDOQL the "ORDER BY timestamp ASC", the "timestamp" is being evaluated as the current time - a built-in function.</p>
</div>
<div class="paragraph">
<p>My fix was to change the JDOQL to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT
FROM org.isisaddons.module.command.dom.CommandJdo
WHERE executeIn == 'FOREGROUND'
   &amp;&amp; timestamp &gt; :timestamp
   &amp;&amp; startedAt != null
   &amp;&amp; completedAt != null
ORDER BY this.timestamp ASC             <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use "this." to qualify the timestamp</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It wasn&#8217;t necessary to qualify the other occurances of "timestamp" (though it would be no harm to do so, either).</p>
</div>
</div>
</div>
</article>
<aside class="article-aside toc hide-for-print" role="navigation">
    <p class="toc-title">On this page</p>
    <div id="article-toc"></div>
</aside>
</main>
</div>
<footer class="footer">
    <div class="content">
        <div class="copyright">
            <p>
                Copyright Â© 2010~2020 The Apache Software Foundation, licensed under the Apache License, v2.0.
                <br/>
                Apache, the Apache feather logo, Apache Isis, and the Apache Isis project logo are all trademarks of The Apache Software Foundation.
            </p>
        </div>
        <div class="revision">
            <p>Revision: 2.0.0-M4.20210304-0425-3fbcd984</p>
        </div>
    </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/jquery-3.4.1.min.js"></script>
<script src="../../_/js/vendor/jquery-ui-1.12.1.custom.widget-only.min.js"></script>
<script src="../../_/js/vendor/jquery.tocify.min.js"></script>

<script>
    $(function() {
        $("#article-toc").tocify( {
            showEffect: "slideDown",
            hashGenerator: "pretty",
            hideEffect: "slideUp",
            selectors: "h2, h3",
            scrollTo: 120,
            smoothScroll: true,
            theme: "jqueryui",
            highlightOnScroll: true
        } );
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
  function focusSearchInput () { document.querySelector('#algolia-search-input').focus() }
  var search = docsearch({
    appId: '5ISP5TFAEN',
    apiKey: '0fc51c28b4ad46e7318e96d4e97fab7c',
    indexName: 'isis-apache-org',
    inputSelector: '#algolia-search-input',
    autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
    debug: false,
  }).autocomplete
  search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
  focusSearchInput()
  window.addEventListener('load', focusSearchInput);
</script>

<!--
  docsearch options:
  https://docsearch.algolia.com/docs/behavior/
-->
<!--
  https://www.algolia.com/doc/api-reference/api-parameters/
  algoliaOptions: { hitsPerPage: 6 },
-->
  </body>
</html>
