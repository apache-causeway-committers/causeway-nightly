<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring DataNucleus :: Apache Isis</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../_/css/site.css">
    <link rel="stylesheet" href="../_/css/site-custom.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="..">
          <span class="icon">
            <img src="../_/img/isis-logo-48x48.png"></img>
          </span>
        <span>Apache Isis</span>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <a class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Quick Start</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Starter Apps</span>
            <a class="navbar-item" href="../starters/helloworld/about.html">Hello World</a>
            <a class="navbar-item" href="../starters/simpleapp/about.html">Simple App</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Demos &amp; Tutorials</span>
            <a class="navbar-item" href="../demoapp/about.html">Demo App</a>
            <a class="navbar-item" href="https://danhaywood.gitlab.io/isis-petclinic-tutorial-docs/petclinic/1.16.2/intro.html">Petclinic (tutorial)</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Core</span>
            <a class="navbar-item" href="../userguide/about.html">User Guide</a>
            <a class="navbar-item" href="../refguide/about.html">Reference Guide</a>
            <a class="navbar-item" href="../testing/about.html">Testing Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Libraries</span>
            <a class="navbar-item" href="../subdomain/about.html">Subdomain Libraries</a>
            <a class="navbar-item" href="../valuetypes/about.html">Value Types</a>
            <a class="navbar-item" href="../mappings/about.html">Bounded Context Mapping Libraries</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Resources</span>
            <a class="navbar-item" href="../toc/devguide/about.html">Developers' Guide</a>
            <a class="navbar-item" href="../toc/mavendeps/about.html">Maven dependencies</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Viewers</span>
            <a class="navbar-item" href="../vw/about.html">Wicket UI</a>
            <a class="navbar-item" href="../vro/about.html">Restful Objects (REST)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Security</span>
            <a class="navbar-item" href="../security/about.html">Security Guide</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Persistence</span>
            <a class="navbar-item" href="../odn/about.html">DataNucleus (JDO)</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Extensions</span>
            <a class="navbar-item" href="../extensions/about.html">Extensions Catalog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Support</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Contact</span>
            <a class="navbar-item" href="../toc/support/slack-channel.html">Slack</a>
            <a class="navbar-item" href="../toc/support/mailing-list.html">Mailing Lists</a>
            <a class="navbar-item" href="https://issues.apache.org/jira/browse/ISIS">JIRA</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/isis">Stack Overflow</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Releases</a>
          <div class="navbar-dropdown">
            <span class="navbar-item navbar-heading">Releases</span>
            <a class="navbar-item" href="../toc/downloads/how-to.html">Downloads</a>
            <a class="navbar-item" href="../relnotes/about.html">Release Notes</a>
            <a class="navbar-item" href="../mignotes/about.html">Migration Notes</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">More Libraries</span>
            <a class="navbar-item" href="../incubator/about.html">Incubator</a>
            <a class="navbar-item" href="../legacy/about.html">Legacy</a>
            <hr class="navbar-divider"/>
            <span class="navbar-item navbar-heading">Internal</span>
            <a class="navbar-item" href="../toc/comguide/about.html">Committers' Guide</a>
            <a class="navbar-item" href="../core/about.html">Core Design</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">ASF</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="http://www.apache.org/">Apache Homepage</a>
            <a class="navbar-item" href="https://www.apache.org/events/current-event">Events</a>
            <a class="navbar-item" href="https://www.apache.org/licenses/">Licenses</a>
            <a class="navbar-item" href="https://www.apache.org/security/">Security</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <hr class="navbar-divider"/>
            <a class="navbar-item" href="https://whimsy.apache.org/board/minutes/Isis.html">PMC board minutes</a>
          </div>
        </div>
        <a class="navbar-item" href="../toc/about.html">
          <span class="icon">
            <img src="../_/img/home.png"></img>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body ">
<div class="nav-container" data-component="pjdo" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="about.html">DataNucleus ObjectStore</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="configuring.html">Configuring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jdo-mappings.html">JDO Mappings</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="db-schemas.html">DB Schemas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="hints-and-tips.html">Hints-n-Tips</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extensions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="flywayjdo/about.html">Flyway for JDO</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">DataNucleus ObjectStore</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title"> </span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../toc/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">BC Mappings Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../mappings/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Core Framework</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../core/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">DataNucleus ObjectStore</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Extensions Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../extensions/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Incubator Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../incubator/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Legacy Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../legacy/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../refguide/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Restful Objects Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../vro/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Security Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../security/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Starter Apps</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../starters/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Subdomains Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../subdomains/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Testing Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../testing/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Tutorial App - Demo</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../demoapp/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">User Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../userguide/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Value Types Catalog</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../valuetypes/about.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Wicket Viewer</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../vw/about.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../toc/about.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="about.html">DataNucleus ObjectStore</a></li>
    <li><a href="configuring.html">Configuring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/apache/isis/edit/HEAD/persistence/jdo/src/main/adoc/modules/ROOT/pages/configuring.adoc">Edit</a></div>
</div>
<article class="doc">
    <a name="section-top"></a>
<h1 class="page">Configuring DataNucleus</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Isis programmatically configures DataNucleus; any Apache Isis properties with the prefix <code>isis.persistor.datanucleus.impl</code> are passed through directly to the JDO/DataNucleus objectstore (with the prefix stripped off, of course).</p>
</div>
<div class="paragraph">
<p>DataNucleus will for itself also and read the <code>META-INF/persistence.xml</code>; at a minimum this defines the name of the "persistence unit".
In theory it could also hold mappings, though in Apache Isis we tend to use annotations instead.</p>
</div>
<div class="paragraph">
<p>Furthermore, DataNucleus will search for various other XML mapping files, eg <code>mappings.jdo</code>.  A full list can be found <a href="http://www.datanucleus.org/products/datanucleus/jdo/metadata.html">here</a>.  The metadata in these XML can be used to override the annotations of annotated entities; see <a href="../userguide/btb/about.html#overriding-jdo-annotations" class="page">Overriding JDO Annotatons</a> for further discussion.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="properties"><a class="anchor" href="#properties"></a>Configuration Properties</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
TODO: v2: these are now in core config properties
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These configuration properties are typically stored in <code>WEB-INF/persistor_datanucleus.properties</code>.  However, you can place all configuration properties into <code>WEB-INF/isis.properties</code> if you wish (the configuration properties from all config files are merged together).</p>
</div>
<div class="sect2">
<h3 id="configuration-properties-for-apache-isis-itself"><a class="anchor" href="#configuration-properties-for-apache-isis-itself"></a>Configuration Properties for Apache Isis itself</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. JDO/DataNucleus Objectstore Configuration Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value<br>
(<em>default value</em>)</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.</code><br>
<code>datanucleus.</code><br>
<code>standaloneCollection.</code><br>
<code>bulkLoad</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code>, <code>false</code><br>
(<code>false</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Enables bulk load of standalone collections.</p>
</div>
<div class="paragraph">
<p>Further <a href="#bulk-load">discussion below</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.</code><br>
<code>datanucleus.</code><br>
<code>classMetadataLoadedListener</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>fully qualified class name<br>
(<code>o.a.i.os.</code><br>
<code>jdo.dn.</code><br>
<code>CreateSchemaObject</code><br>
<code>FromClassMetadata</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The default implementation creates a DB schema object.</p>
</div>
<div class="paragraph">
<p>There generally is no need to change this from its default.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.</code><br>
<code>datanucleus.</code><br>
<code>RegisterEntities.</code><br>
<code>packagePrefix</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>fully qualified package names, CSV</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>This property is derived automatically derived from the set of modules provided in the <a href="../refguide/applib-cm/classes/super.html#AppManifest" class="page"><code>AppManifest</code></a>, and so does not need to be specified explicitly.</p>
</div>
<div class="paragraph">
<p>It holds the set of packages to search so that DataNucleus builds its metamodel eagerly rather than lazily.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Also:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value<br>
(default value)</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.</code><br>
<code>disable</code><br>
<code>ConcurrencyChecking</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code>,<code>false</code><br>
(<code>false</code>)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Disables concurrency checking globally. <br></p>
</div>
<div class="paragraph">
<p>Only intended for "emergency use" as a workaround while pending fix/patch to Apache Isis itself.  (Note that there is no "datanucleus" in the property).</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="configuration-properties-passed-through-directly-to-datanucleus"><a class="anchor" href="#configuration-properties-passed-through-directly-to-datanucleus"></a>Configuration Properties passed through directly to DataNucleus.</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. JDO/DataNucleus Objectstore Configuration Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value<br>
(<em>default value</em>)</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Passed through directly to Datanucleus (with <code>isis.persistor.datanucleus.impl</code> prefix stripped)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>isis.persistor.datanucleus.impl.</code><br>
<code>datanucleus.persistenceByReachabilityAtCommit</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>We recommend this setting is disabled. <br>
Further <a href="#disabling-persistence-by-reachability">discussion below</a>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bulk-load"><a class="anchor" href="#bulk-load"></a>Bulk Load of Standalone Collections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The implementation of user interactions (meaning either an action invocations or a property edits) in the <a href="../vw/about.html" class="page">Wicket viewer</a> is splits into two.
The first phase performs the actual interaction, with the results (dirtied objects) flushed to the database.
The second phase then renders the results of the interaction.</p>
</div>
<div class="paragraph">
<p>When the user interaction in question is an action invocation that returns a list of objects, the resultant list is not rendered in the first phase.
Instead, only the IDs of the objects in the list are captured.
When the list is then rendered, the framework re-loads each object.</p>
</div>
<div class="paragraph">
<p>The default implementation does this row-by-row, resulting in multiple queries against the database.
Setting the property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">isis.persistor.datanucleus.standaloneCollection.bulkLoad=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>changes to a more efficient implementation that bulk loads all the objects using a single query.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the future the bulkLoad implementation may be made the default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The implementation of parented collections does not suffer from this issue; the rendering phase runs the query to obtain the matches.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disabling-persistence-by-reachability"><a class="anchor" href="#disabling-persistence-by-reachability"></a>Persistence by Reachability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, JDO/DataNucleus supports the concept of <a href="http://www.datanucleus.org/products/datanucleus/jdo/persistence.html#persistence_by_reachability">persistence-by-reachability</a>.
That is, if a non-persistent entity is associated with an already-persistent entity, then DataNucleus will detect this and will automatically persist the associated object.
Put another way: there is no need to call Apache Isis' <code>RepositoryService#persist(.)</code> or <code>RepositoryService#persistAndFlush(.)</code> methods.</p>
</div>
<div class="paragraph">
<p>However, convenient though this feature is, you may find that it causes performance issues.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DataNucleus' persistence-by-reachability may cause performance issues.
We strongly recommend that you disable it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One scenario in particular where this performance issues can arise is if your entities implement the <code>java.lang.Comparable</code> interface, and you have used Apache Isis' <a href="../refguide/applib-cm/classes/utility.html#ObjectContracts" class="page"><code>ObjectContracts</code></a> utility class.
The issue here is that <code>ObjectContracts</code> implementation can cause DataNucleus to recursively rehydrate a larger number of associated entities.
(More detail below).</p>
</div>
<div class="paragraph">
<p>We therefore recommend that you disable persistence-by-reachability by adding the following to <code>persistor_datanucleus.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">isis.persistor.datanucleus.impl.datanucleus.persistenceByReachabilityAtCommit=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This change has been made to both the <a href="https://github.com/apache/isis-app-helloworld">HelloWorld</a> and <a href="https://github.com/apache/isis-app-simpleapp">SimpleApp</a> archetypes.</p>
</div>
<div class="paragraph">
<p>If you do disable this feature, then you will (of course) need to ensure that you explicitly persist all entities using the <code>RepositoryService#persist(.)</code> or <code>RepositoryService#persistAndFlush(.)</code> methods.</p>
</div>
<div class="sect2">
<h3 id="the-issue-in-more-detail"><a class="anchor" href="#the-issue-in-more-detail"></a>The issue in more detail</h3>
<div class="paragraph">
<p>Consider these entities (<a href="http://yuml.me/edit/b8681268">yuml.me/b8681268</a>):</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/runtime/configuring-datanucleus/disabling-persistence-by-reachability/party-agreementrole-agreement.png"><img src="_images/runtime/configuring-datanucleus/disabling-persistence-by-reachability/party-agreementrole-agreement.png" alt="party agreementrole agreement" width="750px"></a>
</div>
</div>
<div class="paragraph">
<p>In the course of a transaction, the <code>Agreement</code> entity is loaded into memory (not necessarily modified), and then new <code>AgreementRole</code>s are associated to it.</p>
</div>
<div class="paragraph">
<p>All these entities implement <code>Comparable</code> using <code>ObjectContracts</code>, and the implementation of <code>AgreementRole</code>'s (simplified) is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class AgreementRole {
    ...
    public int compareTo(AgreementRole other) {
        return ObjectContracts.compareTo(this, other, "agreement","startDate","party");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>while <code>Agreement</code>'s is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Agreement {
    ...
    public int compareTo(Agreement other) {
        return ObjectContracts.compareTo(this, other, "reference");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and <code>Party</code>'s is similarly implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Party {
    ...
    public int compareTo(Party other) {
        return ObjectContracts.compareTo(this, other, "reference");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DataNucleus&#8217;s persistence-by-reachability algorithm adds the <code>AgreementRole</code> instances into a <code>SortedSet</code>, which causes <code>AgreementRole#compareTo()</code> to fire:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the evaluation of the "agreement" property delegates back to the <code>Agreement</code>, whose own <code>Agreement#compareTo()</code> uses the scalar <code>reference</code> property.
As the <code>Agreement</code> is already in-memory, this does not trigger any further database queries</p>
</li>
<li>
<p>the evaluation of the "startDate" property is just a scalar property of the <code>AgreementRole</code>, so will already in-memory</p>
</li>
<li>
<p>the evaluation of the "party" property delegates back to the <code>Party</code>, whose own <code>Party#compareTo()</code> requires the uses the scalar <code>reference</code> property.
However, since the <code>Party</code> is not yet in-memory, using the <code>reference</code> property triggers a database query to "rehydrate" the <code>Party</code> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In other words, in figuring out whether <code>AgreementRole</code> requires the persistence-by-reachability algorithm to run, it causes the adjacent associated entity <code>Party</code> to also be retrieved.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence-xml"><a class="anchor" href="#persistence-xml"></a><code>persistence.xml</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>DataNucleus will for itself also and read the <code>META-INF/persistence.xml</code>.
In theory it can hold mappings and even connection strings.
However, with Apache Isis we tend to use annotations instead and externalize connection strings. so its definition is extremely simply, specifying just the name of the "persistence unit".</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the one provided by the <a href="https://github.com/apache/isis-app-simpleapp">SimpleApp archetype</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd" version="1.0"&gt;

    &lt;persistence-unit name="simple"&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally all one needs to do is to change the <code>persistence-unit</code> name.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use Eclipse IDE on Windows then <a href="../toc/devguide/about.html#workaround-for-path-limits" class="page">note the importance</a> of the <code>persistence.xml</code> file to make DataNucleus enhancer work correctly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="http://www.datanucleus.org/products/datanucleus/jdo/persistence.html#persistenceunit">DataNucleus' documentation</a> on <code>persistence.xml</code> to learn more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-jndi-data-source"><a class="anchor" href="#using-jndi-data-source"></a>Using JNDI DataSource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Isis' JDO objectstore can be configured either to connect to the database using its own connection pool, or by using a container-managed datasource.</p>
</div>
<div class="sect2">
<h3 id="application-managed"><a class="anchor" href="#application-managed"></a>Application managed</h3>
<div class="paragraph">
<p>Using a connection pool managed directly by the application (that is, by Apache Isis' JDO objectstore and ultimately by DataNucleus) requires a single set of configuration properties to be specified.</p>
</div>
<div class="paragraph">
<p>In either <code>WEB-INF\isis.properties</code> file (or <code>WEB-INF\persistor.properties</code>, or <code>WEB-INF\persistor_datanucleus.properties</code>), specify the connection driver, url, username and password.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">isis.persistor.datanucleus.impl.javax.jdo.option.ConnectionDriverName=net.sf.log4jdbc.DriverSpy
isis.persistor.datanucleus.impl.javax.jdo.option.ConnectionURL=jdbc:log4jdbc:hsqldb:mem:test
isis.persistor.datanucleus.impl.javax.jdo.option.ConnectionUserName=sa
isis.persistor.datanucleus.impl.javax.jdo.option.ConnectionPassword=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those configuration properties that start with the prefix <code>isis.persistor.datanucleus.impl.</code> are passed through directly to DataNucleus (with the prefix removed).</p>
</div>
<div class="paragraph">
<p>It is also possible to specify the `
datanucleus.ConnectionPasswordDecrypter
` property; see the <a href="http://www.datanucleus.org/products/accessplatform_4_1/persistence_properties.html#ConnectionPasswordDecrypter">DataNucleus documentation</a> for further details.</p>
</div>
</div>
<div class="sect2">
<h3 id="container-managed-jndi"><a class="anchor" href="#container-managed-jndi"></a>Container managed (JNDI)</h3>
<div class="paragraph">
<p>Using a datasource managed by the servlet container requires three separate bits of configuration.</p>
</div>
<div class="paragraph">
<p>Firstly, specify the name of the datasource in the <code>WEB-INF\persistor_datanucleus.properties</code> file. For example:</p>
</div>
<div class="paragraph">
<p>If connection pool settings are also present in this file, they will simply be ignored. Any other configuration properties that start with the prefix <code>isis.persistor.datanucleus.impl.</code> are passed through directly to DataNucleus (with the prefix removed).</p>
</div>
<div class="paragraph">
<p>Secondly, in the <code>WEB-INF/web.xml</code>, declare the resource reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;resource-ref&gt;
    &lt;description&gt;db&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/simpleapp&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, declare the datasource as required by the servlet container. For example, if using Tomcat 7, the datasource can be specified by adding the following to <code>$TOMCAT_HOME/conf/context.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;Resource name="jdbc/simpleapp"
  auth="Container"
  type="javax.sql.DataSource"
  maxActive="100"
  maxIdle="30"
  maxWait="10000"
  username="sa"
  password="p4ssword"
  driverClassName="com.microsoft.sqlserver.jdbc.SQLServerDriver"
  url="jdbc:sqlserver://127.0.0.1:1433;instance=.;databaseName=simpleapp"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will also need to make sure that the JDBC driver is on the servlet container&#8217;s classpath. For Tomcat, this means copying the driver to <code>$TOMCAT_HOME/lib</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>According to Tomcat&#8217;s documentation, it is supposedly possible to copy the <code>conf/context.xml</code> to the name of the webapp, eg <code>conf/mywebapp.xml</code>, and scope the connection to that webapp only.  I was unable to get this working, however.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
<aside class="article-aside toc" role="navigation">
    <p class="toc-title">On this page</p>
    <div id="article-toc"></div>
</aside>
</main>
</div>
<footer class="footer">
    <div class="content">
        <div class="copyright">
            <p>
                Copyright © 2010~2019 The Apache Software Foundation, licensed under the Apache License, v2.0.
                <br/>
                Apache, the Apache feather logo, Apache Isis, and the Apache Isis project logo are all trademarks of The Apache Software Foundation.
            </p>
        </div>
        <div class="revision">
            <p>Revision: 2.0.0-M2.20200119-1120-29a8b9ad</p>
        </div>
    </div>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/vendor/jquery-3.4.1.min.js"></script>
<script src="../_/js/vendor/jquery-ui-1.12.1.custom.widget-only.min.js"></script>
<script src="../_/js/vendor/jquery.tocify.min.js"></script>

<script>
    $(function() {
        $("#article-toc").tocify( {
            showEffect: "slideDown",
            hideEffect: "slideUp",
            selectors: "h2, h3",
            scrollTo: 120,
            smoothScroll: true,
            theme: "jqueryui",
            highlightOnScroll: true
        } );
    });
</script>
  </body>
</html>
